# 13. Zigbee와 Z-Wave

**이전**: [클라우드 IoT 통합](./12_Cloud_IoT_Integration.md) | **다음**: [다중 센서 융합](./14_Multi_Sensor_Fusion.md)

## 학습 목표

이 레슨을 완료하면 다음을 할 수 있습니다:

1. Zigbee, Z-Wave, Thread, Matter 프로토콜을 주파수, 범위, 전력, 메시(mesh) 토폴로지 관점에서 비교한다
2. Zigbee와 Thread의 기반이 되는 IEEE 802.15.4 물리 계층(PHY)과 MAC 계층을 설명한다
3. 코디네이터(coordinator), 라우터(router), 단말 기기(end device)를 포함한 Zigbee의 메시 네트워킹 아키텍처를 기술한다
4. 메시지 라우팅과 기기 관리가 포함된 시뮬레이션 Zigbee 메시 네트워크를 구현한다
5. 주어진 IoT 사용 사례에 가장 적합한 무선 프로토콜을 평가한다

---

WiFi와 블루투스(Bluetooth)는 개인 기기에 잘 맞지만, 스마트홈과 산업용 IoT는 다른 요구사항을 가진다: 수백 개의 기기, 수년간의 배터리 수명, 벽을 통과하는 안정적인 커버리지. Zigbee와 Z-Wave는 바로 이런 제약에 맞게 설계되었다. 이 레슨에서는 두 프로토콜을 모두 탐색하고, 최신 Thread/Matter 표준과 비교하며, 메시 네트워킹이 대규모 IoT 배포를 어떻게 가능하게 하는지 보여준다.

---

## 목차

1. [저전력 무선 환경](#1-저전력-무선-환경)
2. [IEEE 802.15.4 기반](#2-ieee-80215-4-기반)
3. [Zigbee 프로토콜 스택](#3-zigbee-프로토콜-스택)
4. [Zigbee 메시 네트워킹](#4-zigbee-메시-네트워킹)
5. [Z-Wave 프로토콜](#5-z-wave-프로토콜)
6. [Thread와 Matter](#6-thread와-matter)
7. [프로토콜 비교](#7-프로토콜-비교)
8. [실제 응용](#8-실제-응용)
9. [연습 문제](#9-연습-문제)

---

## 1. 저전력 무선 환경

### 1.1 왜 WiFi로 충분하지 않은가?

| 요구사항 | WiFi | BLE | Zigbee | Z-Wave |
|-------------|------|-----|--------|--------|
| 배터리 수명 | 시간~일 | 개월 | 수년 | 수년 |
| 최대 기기 수 | ~32 | 7 (피코넷) | 65,000 | 232 |
| 범위 (실내) | 30-50m | 10-30m | 10-30m | 30-100m |
| 메시 지원 | 없음 (AP 기반) | 제한적 (BLE Mesh) | 기본 제공 | 기본 제공 |
| 데이터 속도 | 54-600 Mbps | 1-2 Mbps | 250 kbps | 100 kbps |
| 송신 전력 | 100-800 mW | 10-20 mW | 1-30 mW | 1-25 mW |

스마트홈 기기는 낮은 빈도(분당 1회 이하)로 매우 작은 패킷(몇 바이트의 "전등 켜기" 또는 "온도 = 22.5°C")을 전송한다. 높은 대역폭은 낭비이며, 저전력과 안정적인 메시 커버리지가 훨씬 더 중요하다.

### 1.2 주파수 대역

```
┌──────────────────────────────────────────────────────────┐
│                 ISM 주파수 대역                            │
├──────────────────────────────────────────────────────────┤
│                                                          │
│  Sub-GHz                                                 │
│  ├─ 868 MHz (EU) ─── Zigbee (선택적), Z-Wave (EU)        │
│  └─ 908 MHz (US) ─── Z-Wave (US)                        │
│                                                          │
│  2.4 GHz (글로벌)                                         │
│  ├─ WiFi (802.11b/g/n)                                   │
│  ├─ Bluetooth / BLE                                      │
│  ├─ Zigbee (802.15.4)                                    │
│  └─ Thread (802.15.4)                                    │
│                                                          │
│  Sub-GHz: 벽 투과성 우수, 더 긴 범위                       │
│  2.4 GHz: 더 높은 데이터 속도, 글로벌 가용성               │
└──────────────────────────────────────────────────────────┘
```

---

## 2. IEEE 802.15.4 기반

IEEE 802.15.4는 Zigbee와 Thread 모두에서 사용되는 물리 계층(PHY)과 매체 접근 제어(MAC, Medium Access Control) 계층을 정의한다.

### 2.1 물리 계층

| 파라미터 | 값 |
|-----------|-------|
| 주파수 | 2.4 GHz (채널 16개), 868/915 MHz |
| 변조 방식 | O-QPSK (2.4 GHz) |
| 데이터 속도 | 250 kbps (2.4 GHz) |
| 채널 대역폭 | 2 MHz |
| 채널 | 11-26 (2.4 GHz 대역) |

### 2.2 MAC 계층

MAC 계층은 CSMA-CA(Carrier Sense Multiple Access with Collision Avoidance, 충돌 회피를 포함한 반송파 감지 다중 접속)를 사용한다:

```
송신자가 전송을 원할 때:
  1. 채널 청취 (CCA = 빈 채널 평가)
  2. 사용 중 → 무작위 백오프(backoff) 후 재시도
  3. 빈 채널 → 프레임 전송
  4. 수신자의 ACK 대기
  5. ACK 없음 → 재시도 (max_retries까지)
```

### 2.3 프레임 형식

```
┌─────────┬──────────┬──────────┬──────────┬─────────┬──────┐
│ 프리앰블 │ SFD      │ 프레임   │ 프레임   │ 페이로드│ FCS  │
│ (4 B)   │ (1 B)    │ 길이     │ 제어     │ (가변)  │(2 B) │
│         │          │ (1 B)    │ (2 B)    │         │      │
└─────────┴──────────┴──────────┴──────────┴─────────┴──────┘
           동기화               MAC 헤더    데이터   체크섬
```

최대 페이로드: 127바이트(설계상 작게 유지 -- 프레임을 짧게 유지하여 신뢰성과 저전력 실현).

---

## 3. Zigbee 프로토콜 스택

Zigbee는 IEEE 802.15.4 위에 네트워크 계층과 애플리케이션 계층을 추가한다:

```
┌─────────────────────────────────────┐
│  애플리케이션 계층                   │
│  ├── ZCL (Zigbee 클러스터 라이브러리)│  표준 기기 프로파일
│  └── ZDO (Zigbee 기기 객체)          │  기기 발견, 관리
├─────────────────────────────────────┤
│  애플리케이션 지원 (APS)              │  바인딩, 그룹 관리
├─────────────────────────────────────┤
│  네트워크 계층 (NWK)                  │  메시 라우팅, 보안
├─────────────────────────────────────┤
│  MAC 계층 (IEEE 802.15.4)            │  CSMA-CA, 프레이밍
├─────────────────────────────────────┤
│  물리 계층 (IEEE 802.15.4)           │  2.4 GHz 라디오
└─────────────────────────────────────┘
```

### 3.1 Zigbee 클러스터 라이브러리(ZCL)

ZCL은 상호운용성을 보장하는 재사용 가능한 기능 블록인 표준 "클러스터(cluster)"를 정의한다:

| 클러스터 | ID | 기능 |
|---------|-----|----------|
| 온/오프 | 0x0006 | 기기 켜기/끄기, 토글 |
| 레벨 제어 | 0x0008 | 밝기 조광 (0-255) |
| 색상 제어 | 0x0300 | 색조, 채도, 색온도 |
| 온도 | 0x0402 | 온도 센서 읽기 |
| 점유 감지 | 0x0406 | 동작 감지 |
| 도어락 | 0x0101 | 잠금/해제, PIN 관리 |
| IAS 구역 | 0x0500 | 침입/알람 센서 |

Zigbee 전구는 온/오프 및 레벨 제어 클러스터를 구현하고, 온도 조절기는 온도 측정 클러스터를 구현한다. 이 클러스터를 지원하는 모든 컨트롤러는 어떤 제조사의 기기든 제어할 수 있다.

---

## 4. Zigbee 메시 네트워킹

### 4.1 기기 역할

| 역할 | 설명 | 전원 | 예시 |
|------|-------------|-------|---------|
| **코디네이터(Coordinator)** | 네트워크를 구성하고, 주소를 할당하며, 네트워크당 하나 | 상시 전원 | 허브, 게이트웨이 |
| **라우터(Router)** | 메시지를 전달하고, 범위를 확장 | 상시 전원 | 스마트 플러그, 전구 |
| **단말 기기(End Device)** | 절전을 위해 슬립하며, 상위 라우터를 통해 통신 | 배터리 | 센서, 버튼 |

### 4.2 네트워크 구성

```
1. 코디네이터 시작:
   - 간섭이 가장 적은 채널 스캔
   - PAN ID (16비트) 선택
   - 가입 요청 수락 시작

2. 라우터 가입:
   - 코디네이터의 비콘(beacon) 스캔
   - 연결 요청(Association Request) 전송
   - 16비트 네트워크 주소 수신
   - 단말 기기의 상위 노드로 사용 가능해짐

3. 단말 기기 가입:
   - 가장 가까운 라우터(신호 강도 가장 강한 것) 탐색
   - 라우터를 상위 노드로 연결
   - 대부분의 시간 슬립
   - 주기적으로 깨어나 상위 노드에서 대기 중인 메시지 폴링
```

### 4.3 메시 라우팅

Zigbee는 AODV(Ad-hoc On-demand Distance Vector, 애드혹 온디맨드 거리 벡터) 라우팅을 사용한다:

```
출발지 → 라우터 A → 라우터 B → 라우터 C → 목적지

1. 출발지가 경로 요청(RREQ) 브로드캐스트
2. 중간 라우터들이 RREQ를 전달하며 역방향 경로 기록
3. 목적지가 역방향 경로를 따라 경로 응답(RREP) 전송
4. 출발지가 발견된 경로를 캐시에 저장
5. 데이터 패킷이 캐시된 경로를 따라 전달
6. 링크 실패 시 → 경로 오류(RERR)가 재탐색 유발
```

### 4.4 자가 복구(Self-Healing)

라우터가 실패하면 메시가 자동으로 경로를 재설정한다:

```
실패 전:                    라우터 B 실패 후:
A ─── B ─── C               A ─── D ─── C
│     │     │                │           │
D ─── E ─── F               │     E ─── F
                             └─────┘
                             (D를 통한 새 경로 발견)
```

---

## 5. Z-Wave 프로토콜

### 5.1 Zigbee와의 주요 차이점

| 특징 | Zigbee | Z-Wave |
|---------|--------|--------|
| 표준 기관 | Zigbee Alliance (CSA) | Z-Wave Alliance (Silicon Labs) |
| 주파수 | 2.4 GHz (글로벌) | Sub-GHz (지역별 상이) |
| 데이터 속도 | 250 kbps | 100 kbps (9.6/40/100) |
| 범위 | 10-30m | 30-100m (Sub-GHz 장점) |
| 최대 기기 수 | 65,000 | 232 |
| 칩 제조사 | 복수 (TI, NXP, Silicon Labs) | Silicon Labs 전용 |
| 상호운용성 | 클러스터 기반 (간혹 문제 발생) | 인증 의무화 |

### 5.2 Z-Wave의 장점

- **Sub-GHz 주파수**: 2.4 GHz보다 벽 투과성이 우수하고 범위가 더 길다
- **의무적 인증**: 모든 Z-Wave 기기는 상호운용성 테스트를 통과해야 하므로, "이론상은 되지만 실제로는 안 되는" 문제가 줄어든다
- **소스 라우팅(source routing)**: Z-Wave는 소스 라우팅을 사용하여(송신자가 전체 경로를 지정) 제한된 기기의 라우팅 테이블 메모리를 절약한다

### 5.3 Z-Wave 메시 토폴로지

```
┌─────────────────────────────────────────────────┐
│               Z-Wave 네트워크                     │
│                                                  │
│   컨트롤러 (1)  ←── 1차 컨트롤러                  │
│       │                라우팅 테이블 관리           │
│   ┌───┼───┐                                      │
│   │   │   │                                      │
│   R1  R2  R3      ←── 라우팅 슬레이브 (항상 켜짐) │
│   │   │   │                                      │
│   S1  S2  S3      ←── 슬레이브 (센서, 배터리)     │
│                                                  │
│   임의 두 기기 간 최대 4홉(hop)                    │
└─────────────────────────────────────────────────┘
```

---

## 6. Thread와 Matter

### 6.1 Thread

Thread는 IEEE 802.15.4를 기반으로 구축된 최신 메시 네트워킹 프로토콜(2014년)로, Zigbee의 한계를 해결하도록 설계되었다:

| 특징 | Thread | Zigbee |
|---------|--------|--------|
| IP 기반 | 예 (IPv6 / 6LoWPAN) | 아니오 (커스텀 주소 체계) |
| 클라우드 통합 | 기본 제공 (IP 라우팅) | 게이트웨이 변환 필요 |
| 보더 라우터(Border Router) | 모든 기기가 될 수 있음 | 단일 코디네이터 |
| 단일 장애점 | 없음 (다수의 BR) | 있음 (코디네이터) |
| 표준 | 개방형 (IETF 표준) | 독점 애플리케이션 계층 |

### 6.2 Matter (이전 명칭: CHIP)

Matter는 Thread, WiFi, 또는 이더넷 위에서 동작하는 애플리케이션 계층 프로토콜이다:

```
┌─────────────────────────────────────────────────┐
│                    Matter                        │
│            (애플리케이션 계층)                    │
│                                                  │
│  통합 기기 모델, 설정 및 제어                      │
│  Apple, Google, Amazon, Samsung 지원              │
├──────────┬──────────┬──────────┬────────────────┤
│  Thread  │   WiFi   │ Ethernet │   BLE          │
│  (메시)  │ (고대역폭)│  (유선)  │ (커미셔닝)     │
└──────────┴──────────┴──────────┴────────────────┘
```

Matter는 파편화 문제를 해결하는 것을 목표로 한다: HomeKit, Google Home, Alexa, SmartThings에서 동시에 작동하는 하나의 표준.

---

## 7. 프로토콜 비교

### 7.1 결정 매트릭스

| 사용 사례 | 최적 프로토콜 | 이유 |
|----------|--------------|-----|
| 스마트홈 (신규) | **Matter** over Thread | 미래 지향적, 다중 에코시스템 |
| 스마트홈 (기존) | **Z-Wave** | 검증된 신뢰성, 긴 범위 |
| 대형 건물 | **Zigbee** | 65K 기기 한도, ZCL 프로파일 |
| 산업용 모니터링 | **Zigbee** 또는 **Thread** | 메시 자가 복구, IP 기반 |
| 배터리 센서 | **Z-Wave** 또는 **Zigbee** | 1mA 미만의 슬립 전류 |
| 실외/장거리 | **LoRaWAN** | km 범위 (여기서는 다루지 않음) |

### 7.2 범위와 투과성

```
실내 범위 (일반적):

Z-Wave (908 MHz):  ████████████████████████████████  30-100m
Zigbee (2.4 GHz):  ████████████████                  10-30m
BLE (2.4 GHz):     ████████████                      10-20m
WiFi (2.4 GHz):    ████████████████████              20-50m

벽 투과성 (상대적):
Z-Wave:  ★★★★★  (Sub-GHz가 더 잘 투과)
Zigbee:  ★★★    (2.4 GHz는 벽에 더 많이 반사)
WiFi:    ★★★    (Zigbee와 유사)
BLE:     ★★     (낮은 송신 전력)
```

---

## 8. 실제 응용

### 8.1 스마트홈 시스템 아키텍처

```
┌─────────────────────────────────────────────────────┐
│                  스마트홈                             │
│                                                      │
│  ┌──────────────┐    ┌──────────────────────────┐   │
│  │  클라우드/앱  │◄──►│  허브/보더 라우터         │   │
│  │ (HomeKit,    │    │  (Matter 컨트롤러)         │   │
│  │  Google Home)│    └──────────┬───────────────┘   │
│  └──────────────┘               │                    │
│                    ┌────────────┼────────────┐       │
│                    │            │            │       │
│              ┌─────┴─────┐ ┌───┴────┐ ┌────┴────┐  │
│              │Thread 메시 │ │Z-Wave  │ │WiFi     │  │
│              │            │ │메시    │ │기기     │  │
│              │• 센서      │ │• 잠금장치│• 카메라 │  │
│              │• 조명      │ │• 플러그│ │• 스피커 │  │
│              │• 스위치    │ │• 블라인드│          │  │
│              └───────────┘ └────────┘ └─────────┘  │
└─────────────────────────────────────────────────────┘
```

### 8.2 산업용 IoT 모니터링

공장의 Zigbee 네트워크는 수백 개의 센서를 모니터링한다:

- 생산 현장 전체의 온도/습도 (100개 이상의 노드)
- 기계의 진동 센서 (예지 보전)
- 대기질 모니터 (안전 준수)
- 자산 추적 태그 (재고 관리)

메시 토폴로지는 경로 다양성과 자가 복구를 통해 가혹한 RF 환경(금속 구조물, 간섭)을 처리한다.

---

## 9. 연습 문제

### 문제 1: 프로토콜 선택

각 시나리오에 가장 적합한 프로토콜을 선택하고 그 이유를 설명하라:
1. 200개 객실 규모의 호텔이 5년 배터리 수명의 무선 도어락을 원한다
2. 온실에서 10에이커에 걸쳐 500개의 토양 수분 센서가 필요하다
3. 집주인이 스마트 전구 15개, 온도 조절기 3개, 도어락 2개를 제어하고 싶다
4. 공장에서 50대의 기계에 대한 실시간 진동 모니터링이 필요하며, 지연 시간이 100ms 미만이어야 한다

### 문제 2: 메시 네트워크 설계

2층 주택(층당 150 m²)을 위한 Zigbee 메시 네트워크를 설계하라:
1. 완전한 커버리지를 위해 필요한 최소 라우터 수를 결정한다
2. 네트워크 토폴로지를 그린다
3. 지하 센서에서 2층 디스플레이까지의 라우팅 경로를 보여준다
4. 계단에 가장 가까운 1층 라우터가 실패할 때 어떤 일이 발생하는지 설명한다

### 문제 3: 전력 예산 분석

Zigbee 단말 기기(배터리 구동 온도 센서)의 사양:
- 배터리: AA 2개 (3V에서 총 3000 mAh)
- 슬립 전류: 5 μA
- 송신 전류: 20 mA
- 측정당 송신 시간: 15 ms
- 측정 빈도: 5분에 1회

예상 배터리 수명을 연 단위로 계산하라. 주된 전력 소비원은 무엇인가?

### 문제 4: Z-Wave 대 Zigbee 범위

콘크리트 벽이 신호를 벽당 12 dB씩 감쇠시키는 집이 있다. 안정적인 수신을 위한 최소 신호 강도는 -95 dBm이다.
1. Zigbee 기기가 0 dBm으로 송신하고 10m에서의 자유공간 경로 손실이 -60 dBm일 때, 신호가 콘크리트 벽을 몇 개 통과할 수 있는가?
2. Z-Wave 기기가 -2 dBm으로 송신하지만 수신 감도가 -5 dBm 더 좋다면(-100 dBm), 몇 개의 벽을 통과할 수 있는가?
3. 메시 라우팅이 이 분석을 어떻게 변화시키는가?

### 문제 5: Thread 네트워크 시뮬레이션

Python으로 간단한 Thread 유사 메시 네트워크 시뮬레이터를 구현하라:
1. 100×100m 영역의 임의 위치에 노드 20개를 생성한다
2. 두 노드를 보더 라우터(Border Router)로 지정한다
3. 임의의 단말 기기와 가장 가까운 보더 라우터 간의 최단 경로(홉 수)를 찾는다
4. 임의의 노드 제거를 시뮬레이션하고, 네트워크가 자가 복구됨을 보여준다(대체 경로 탐색)

---

*레슨 13 끝*
