# 전력 관리

**이전**: [RISC-V 아키텍처](./19_RISC_V_Architecture.md)

**난이도**: ⭐⭐⭐⭐

**선수 과목**: CPU 아키텍처, 병렬 처리와 멀티코어(Parallel Processing and Multicore) (18강)

---

## 학습 목표

이 강의를 마치면 다음을 할 수 있습니다:

1. CMOS 회로의 전력 소비 원인(동적, 정적, 단락 회로)을 설명할 수 있다
2. 동적 전압 및 주파수 스케일링(Dynamic Voltage and Frequency Scaling, DVFS)을 설명하고 절전 효과를 계산할 수 있다
3. 능동 전력과 누설 전력을 줄이는 기법으로서 클록 게이팅(Clock Gating)과 전원 게이팅(Power Gating)을 설명할 수 있다
4. 다크 실리콘(Dark Silicon) 문제와 멀티코어 확장에 미치는 영향을 분석할 수 있다
5. 현대 프로세서의 에너지 비례 컴퓨팅(Energy-Proportional Computing) 접근 방식을 비교할 수 있다

---

최신 노트북 프로세서는 이메일을 읽을 때 5와트, 영상을 렌더링할 때 60와트를 소비할 수 있습니다. 스마트폰 SoC는 약 15Wh를 저장하는 배터리로 하루 종일 버텨야 합니다. 데이터 센터는 연산만큼이나 냉각에도 비용을 씁니다. 전력 관리는 더 이상 틈새 관심사가 아닙니다. 트랜지스터 설계부터 운영체제 스케줄링까지 컴퓨터 아키텍처의 모든 수준을 형성합니다.

---

## 목차

1. [CMOS 전력의 기초](#1-cmos-전력의-기초)
2. [동적 전압 및 주파수 스케일링](#2-동적-전압-및-주파수-스케일링)
3. [클록 게이팅](#3-클록-게이팅)
4. [전원 게이팅](#4-전원-게이팅)
5. [다크 실리콘](#5-다크-실리콘)
6. [프로세서 전력 상태](#6-프로세서-전력-상태)
7. [에너지 비례 컴퓨팅](#7-에너지-비례-컴퓨팅)
8. [열 관리](#8-열-관리)
9. [연습 문제](#9-연습-문제)

---

## 1. CMOS 전력의 기초

CMOS 회로의 총 전력은 세 가지 구성 요소를 가집니다:

$$P_{total} = P_{dynamic} + P_{static} + P_{short-circuit}$$

### 1.1 동적 전력(Dynamic Power)

동적 전력은 트랜지스터가 스위칭될 때 커패시터를 충전하고 방전하면서 발생합니다:

$$P_{dynamic} = \alpha \cdot C \cdot V_{dd}^2 \cdot f$$

| 기호 | 의미 | 일반적인 값 |
|--------|---------|---------------|
| α | 활동 계수(사이클당 스위칭되는 게이트 비율) | 0.1 - 0.3 |
| C | 총 부하 커패시턴스 | 공정 의존 |
| V_dd | 공급 전압 | 0.6 - 1.2 V |
| f | 클록 주파수 | 1 - 5 GHz |

핵심 통찰: 전력은 전압의 **제곱**에 비례합니다. 전압을 1.0V에서 0.7V로 낮추면 동적 전력이 51% 감소합니다 (0.7² / 1.0² = 0.49).

### 1.2 정적 전력(누설, Static Power / Leakage)

트랜지스터가 스위칭하지 않을 때도 전류가 누설됩니다:

$$P_{static} = V_{dd} \cdot I_{leak}$$

트랜지스터가 축소될수록 누설 전류는 지수적으로 증가합니다. 7nm 이하에서 누설은 총 칩 전력의 30-50%를 차지할 수 있습니다.

| 누설 유형 | 원인 | 완화 방법 |
|-------------|-------|------------|
| 서브-임계값(Sub-threshold) | 게이트가 "꺼져" 있어도 전류 흐름 | 더 높은 임계 전압 (속도 감소) |
| 게이트 산화물 터널링 | 얇은 게이트 산화물을 통한 터널링 | 고유전율 유전체 (HfO₂) |
| 접합 누설(Junction leakage) | 역방향 바이어스된 p-n 접합 전류 | 웰 바이어싱(Well biasing) |

### 1.3 단락 회로 전력(Short-Circuit Power)

스위칭 전환 중에 PMOS와 NMOS 트랜지스터가 잠깐 동시에 켜져 V_dd에서 접지까지 직접 경로가 생성됩니다. 이는 일반적으로 동적 전력의 5-10%를 차지하며, 빠른 전환 시간을 보장하여 최소화합니다.

---

## 2. 동적 전압 및 주파수 스케일링

DVFS(Dynamic Voltage and Frequency Scaling)는 전압과 주파수를 함께 조정합니다. 그 이유는 다음과 같습니다:
- 더 높은 주파수는 신뢰할 수 있는 스위칭을 위해 더 높은 전압을 필요로 함
- 낮은 주파수는 더 낮은 전압을 허용함

### 2.1 DVFS 동작 지점

```
┌────────────────────────────────────────────────────────────┐
│           DVFS Operating Points                             │
├──────────┬───────────┬──────────┬───────────┬──────────────┤
│ Mode     │ Frequency │ Voltage  │ Rel Power │ Performance  │
├──────────┼───────────┼──────────┼───────────┼──────────────┤
│ Turbo    │ 4.5 GHz   │ 1.20 V   │ 100%      │ Maximum      │
│ High     │ 3.5 GHz   │ 1.00 V   │  54%      │ 78%          │
│ Normal   │ 2.5 GHz   │ 0.85 V   │  28%      │ 56%          │
│ Low      │ 1.5 GHz   │ 0.70 V   │  12%      │ 33%          │
│ Idle     │ 0.8 GHz   │ 0.60 V   │   5%      │ 18%          │
└──────────┴───────────┴──────────┴───────────┴──────────────┘
```

### 2.2 전력-성능 절충

주파수를 절반으로 줄이고 전압을 비례적으로 낮추면:
- 성능: 절반 (2배 느림)
- 동적 전력: 약 8배 감소 (P ∝ V² × f이며, V도 함께 낮아지기 때문)
- 작업당 에너지: 실제로 감소할 수 있음 (전력 감소 속도가 시간 증가 속도보다 빠름)

즉, 낮은 전압/주파수로 실행하면 작업에 더 오랜 시간이 걸리더라도 에너지 효율이 더 높을 수 있습니다.

### 2.3 실제 DVFS

| 플랫폼 | DVFS 기술 | 제어 방식 |
|----------|----------------|---------|
| Intel | SpeedStep / Speed Shift (HWP) | OS 힌트를 받아 하드웨어 관리 |
| AMD | Cool'n'Quiet / Precision Boost | 펌웨어 + OS 거버너 |
| ARM | big.LITTLE + 클러스터별 DVFS | OS DVFS 드라이버 |
| RISC-V | 플랫폼 별 (SBI 호출) | OS 또는 펌웨어 |

Linux는 `cpufreq` 서브시스템을 통해 DVFS를 노출합니다:

```bash
# View available governors
cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_available_governors
# performance  powersave  ondemand  conservative  schedutil

# Set governor
echo "schedutil" | sudo tee /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor

# View current frequency (kHz)
cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_cur_freq
```

---

## 3. 클록 게이팅

클록 게이팅(Clock Gating)은 사용하지 않는 회로 블록에 클록 신호를 중단시켜 동적 전력 소비를 제거합니다.

### 3.1 동작 원리

```
                    ┌─────────┐
Clock ──────┐       │         │
            ├─ AND ─┤ Circuit │
Enable ─────┘       │  Block  │
                    └─────────┘

When Enable = 0:
  - Clock signal does not reach the circuit
  - No switching activity → no dynamic power
  - Register values are preserved (static)
```

### 3.2 세분화 수준

| 수준 | 게이팅 대상 | 절감 효과 | 재개 지연 |
|-------|----------------|---------|-------------------|
| **세밀(Fine-grained)** | 개별 기능 유닛 (ALU, FPU) | 5-15% | 0 사이클 |
| **중간(Medium)** | 실행 파이프라인 단계 | 15-30% | 1-3 사이클 |
| **거친(Coarse)** | 전체 코어 또는 IP 블록 | 30-60% | 10-100 사이클 |

현대 프로세서는 자동 클록 게이팅을 사용합니다. 하드웨어가 유닛에 작업이 없을 때를 감지하여 소프트웨어 개입 없이 클록을 게이팅합니다.

### 3.3 예시: Intel 클록 게이팅

Intel 프로세서는 여러 수준에서 클록을 게이팅합니다:
- **명령어 수준**: 사용하지 않는 실행 포트는 매 사이클 클록 게이팅됨
- **코어 수준**: 유휴 코어는 클록 중단 (C1 상태)
- **언코어(Uncore)**: L3 캐시 슬라이스, 메모리 컨트롤러, 인터커넥트를 독립적으로 게이팅 가능

---

## 4. 전원 게이팅

전원 게이팅(Power Gating)은 전원 공급 자체를 완전히 차단하여 동적 전력과 누설 전력 모두를 제거하는 클록 게이팅보다 한 단계 더 나아간 기법입니다.

### 4.1 구현

```
V_dd ──────┤ Power Switch (Sleep Transistor)
            │
         ┌──┴──────────────┐
         │                 │
         │  Logic Block    │ ← Virtual V_dd
         │                 │
         └──┬──────────────┘
            │
GND ────────┘
```

슬립 트랜지스터(sleep transistor)는 대형 PMOS 소자로 논리 블록을 V_dd에서 분리합니다. 꺼진 상태에서는:
- 전류 흐름 없음 → 동적 전력과 누설 전력 모두 제로
- 모든 레지스터/메모리 상태가 **손실됨** (미리 저장해야 함)

### 4.2 상태 보존

전원 게이팅 중 상태를 보존하기 위한 방법:

| 기법 | 방법 | 비용 |
|-----------|-----|------|
| **소프트웨어 저장/복원** | OS가 전원 차단 전에 레지스터를 DRAM에 저장 | 높은 지연 (μs-ms) |
| **보존 레지스터(Retention registers)** | 특수 항상-켜짐 플립플롭이 중요한 상태 유지 | 면적 오버헤드 (~10%) |
| **보존 전압(Retention voltage)** | 매우 낮은 전압 유지 (데이터 유지, 스위칭 없음) | 소량의 누설 남음 |

### 4.3 전원 게이팅 vs 클록 게이팅

| 측면 | 클록 게이팅 | 전원 게이팅 |
|--------|-------------|-------------|
| 동적 전력 제거 | 예 | 예 |
| 누설 전력 제거 | 아니오 | 예 |
| 상태 보존 | 자동 | 저장/복원 필요 |
| 웨이크업 지연 | 0-3 사이클 | 10-1000+ 사이클 |
| 하드웨어 복잡도 | 낮음 | 높음 (슬립 트랜지스터, 보존 회로) |

---

## 5. 다크 실리콘

### 5.1 문제점

트랜지스터가 축소되면서 칩에 더 많이 집적되지만, 전력 밀도 한계로 인해 모든 트랜지스터를 동시에 구동할 수 없습니다. 언제든지 전원이 꺼져 있어야 하는 칩의 비율을 **다크 실리콘(dark silicon)**이라고 합니다.

```
Moore's Law says:  Transistor count doubles every 2 years
Dennard Scaling says: Power density stays constant as transistors shrink
                      (THIS BROKE DOWN around 45nm / ~2006)

Result: We can build chips with 10 billion transistors,
        but can only power ~30-50% of them at once.
```

### 5.2 추정치

8nm 기술에서 연구들은 일반적인 열설계전력(TDP, Thermal Design Power) 제약 하에서 언제든지 칩 면적의 50-80%가 다크(dark) 상태여야 한다고 추정합니다.

### 5.3 다크 실리콘 대응 전략

| 전략 | 설명 | 예시 |
|----------|-------------|---------|
| **딤 실리콘(Dim silicon)** | 모든 코어를 낮은 V/f로 실행 | DVFS (2절) |
| **이기종 코어(Heterogeneous cores)** | 빅+스몰 코어 혼합, 필요에 따라 활성화 | ARM big.LITTLE, Intel P+E 코어 |
| **특수 가속기(Specialized accelerators)** | 다크 영역을 특수 목적 유닛으로 활용 | GPU, NPU, 비디오 인코드/디코드, 암호화 |
| **칩렛(Chiplets)** | 독립적인 전력 도메인을 가진 별도 다이 | AMD Zen (CCD + IOD) |
| **임계값 근처 컴퓨팅(Near-threshold computing)** | 트랜지스터를 임계 전압 근처에서 동작 | 연구 프로토타입 |

### 5.4 현대 이기종 설계

Apple M 시리즈 칩은 이기종 접근 방식의 모범 사례입니다:

```
┌──────────────────────────────────────────────────┐
│                Apple M4 Pro SoC                   │
├──────────────────────────────────────────────────┤
│  ┌──────────────┐  ┌──────────────┐              │
│  │ Performance   │  │ Efficiency   │              │
│  │ Cores (6)     │  │ Cores (4)    │              │
│  │ High V/f      │  │ Low V/f      │  ← big.LITTLE│
│  │ High IPC       │  │ Low power    │              │
│  └──────────────┘  └──────────────┘              │
│  ┌──────────────┐  ┌──────────────┐              │
│  │ GPU (20 core) │  │ Neural Engine│              │
│  │ Graphics      │  │ ML inference │  ← Accelerators│
│  └──────────────┘  └──────────────┘              │
│  ┌──────────────┐  ┌──────────────┐              │
│  │ Media Engine  │  │ Secure       │              │
│  │ H.264/265/AV1│  │ Enclave      │              │
│  └──────────────┘  └──────────────┘              │
└──────────────────────────────────────────────────┘
```

현재 작업에 필요한 구성 요소만 완전히 전원이 켜집니다. 영상 재생은 미디어 엔진(저전력)을 사용하고, ML 학습은 Neural Engine과 GPU를 사용하며, 이메일은 효율 코어만 사용합니다.

---

## 6. 프로세서 전력 상태

### 6.1 ACPI C-상태

고급 구성 및 전원 인터페이스(ACPI, Advanced Configuration and Power Interface)는 프로세서 유휴 상태를 정의합니다:

| 상태 | 이름 | 설명 | 웨이크업 지연 |
|-------|------|-------------|-------------|
| **C0** | 활성(Active) | 명령어 실행 중 | 0 |
| **C1** | 중지(Halt) | 클록 중단, 전압 유지 | ~1 μs |
| **C1E** | 향상된 중지(Enhanced Halt) | C1 + 전압 감소 | ~10 μs |
| **C3** | 슬립(Sleep) | L1/L2 캐시 플러시, 클록 중단 | ~50-100 μs |
| **C6** | 딥 슬립(Deep Sleep) | 코어 전원 게이팅, 상태 저장 | ~100-200 μs |
| **C7** | 더 깊은 슬립(Deeper Sleep) | L2 캐시도 플러시 | ~200-400 μs |
| **C10** | 패키지 슬립(Package Sleep) | 모든 코어 꺼짐, PMC만 활성 | ~1-5 ms |

### 6.2 P-상태 (성능 상태, P-States)

P-상태는 DVFS를 통해 활성 성능을 제어합니다:
- P0: 최대 성능 (터보 부스트)
- P1: 최대 비-터보 주파수
- Pn: 최소 동작 주파수

OS 스케줄러와 하드웨어가 협력하여 작업 부하에 따라 올바른 P-상태를 선택합니다.

### 6.3 패키지 vs 코어 전력 상태

```
Package C-state = deepest state where ALL cores are idle

Core 0: C6 (deep sleep)
Core 1: C1 (halt)       → Package state = C1 (limited by shallowest)
Core 2: C6 (deep sleep)
Core 3: C6 (deep sleep)

Core 0: C6
Core 1: C6              → Package state = C6 (all cores deep sleep)
Core 2: C6                 Now package-level power savings apply
Core 3: C6
```

---

## 7. 에너지 비례 컴퓨팅

### 7.1 문제점

서버는 대부분의 시간을 10-50% 활용률로 보내지만, 유휴 상태에서의 전력 소비는 여전히 최대의 50-60%입니다. 활용률과 전력 사이의 관계는 선형과 거리가 멉니다:

```
Power
(Watts)
  200 ├─────────────────────────────────●  Peak
      │                            ●
  150 ├                       ●
      │                  ●
  100 ├─────────────●                     ← Ideal: linear
      │         ●
   50 ├─ ●──                              ← Actual: high idle power
      │  ↑ Idle power (~50% of peak)
    0 ├──┬──┬──┬──┬──┬──┬──┬──┬──┬──
      0  10 20 30 40 50 60 70 80 90 100
                  Utilization (%)
```

### 7.2 접근 방식

| 접근 방식 | 설명 | 효과 |
|----------|-------------|--------------|
| **DVFS** | 부하에 따라 전압/주파수 조정 | 보통 (동적 전력만) |
| **전원 게이팅** | 유휴 코어 완전 차단 | 높음 (누설도 제거) |
| **서버 통합** | VM을 소수 서버로 마이그레이션, 나머지 전원 차단 | 매우 높음 |
| **이기종 컴퓨팅** | 가장 효율적인 컴퓨팅 유닛으로 작업 라우팅 | 높음 |
| **근데이터 처리(Near-data processing)** | 저장소 근처에서 데이터를 처리하여 전송 에너지 절감 | 보통 |

### 7.3 전력 사용 효율(Power Usage Effectiveness, PUE)

데이터 센터 효율은 PUE로 측정됩니다:

$$PUE = \frac{\text{Total Facility Power}}{\text{IT Equipment Power}}$$

| PUE | 등급 | 의미 |
|-----|--------|---------|
| 2.0+ | 나쁨 | 냉각, 조명, UPS에 50% 이상 오버헤드 |
| 1.4 | 보통 | 업계 평균 |
| 1.1 | 우수 | Google, Meta가 고급 냉각으로 달성 |
| 1.0 | 이상적 | 모든 전력이 연산에 사용 (실제로는 불가능) |

---

## 8. 열 관리

### 8.1 열설계전력(Thermal Design Power, TDP)

TDP는 냉각 시스템이 방열해야 하는 최대 지속 전력입니다. 최대 전력 소비(터보 버스트 중에는 TDP를 초과할 수 있음)와는 다릅니다.

| 프로세서 | TDP | 최대 전력 |
|-----------|-----|-----------|
| Intel Core i9-14900K | 125 W | 253 W (터보) |
| AMD Ryzen 9 7950X | 170 W | 230 W (PPT) |
| Apple M4 Pro | ~30 W | ~40 W |
| ARM Cortex-A78 (코어당) | ~1 W | ~1.5 W |

### 8.2 열 스로틀링(Thermal Throttling)

칩 온도가 접합 온도 한계(T_j,max, 일반적으로 100-105°C)를 초과하면:

1. **DVFS 스로틀링**: 주파수와 전압 감소
2. **클록 변조(Clock modulation)**: 유휴 사이클 삽입 (듀티 사이클링)
3. **코어 파킹(Core parking)**: 뜨거운 코어에서 작업 이전
4. **긴급 종료**: 스로틀링에도 온도가 계속 상승하면

### 8.3 냉각 기술

| 기술 | 일반적인 적용 | 방열 능력 |
|-----------|-------------------|-----------------|
| 수동 방열판(Passive heatsink) | 저전력 SoC | 5-30 W |
| 능동 팬 + 방열판(Active fan + heatsink) | 데스크탑/노트북 CPU | 65-250 W |
| 베이퍼 챔버(Vapor chamber) | 고성능 노트북, GPU | 100-400 W |
| 수냉(Liquid cooling, AIO) | 매니아 데스크탑 | 200-500 W |
| 직접 수냉(Direct liquid cooling) | 데이터 센터 | 500+ W |
| 침지 냉각(Immersion cooling) | HPC, 암호화폐 | 1000+ W |

---

## 9. 연습 문제

### 문제 1: 전력 계산

프로세서의 사양이 다음과 같습니다:
- 활동 계수 α = 0.2
- 부하 커패시턴스 C = 20 nF
- 공급 전압 V_dd = 1.0 V
- 클록 주파수 f = 3.0 GHz
- 누설 전류 I_leak = 10 A

다음을 계산하십시오: (a) 동적 전력, (b) 정적 전력, (c) 총 전력. 전압을 0.7V로, 주파수를 2.0GHz로 낮추면 새로운 값은 얼마입니까?

### 문제 2: DVFS 에너지 분석

어떤 작업이 100억 사이클을 필요로 합니다. 다음 두 가지 옵션을 비교하십시오:
- 옵션 A: 4 GHz, 1.2V (TDP = 100W 동적)
- 옵션 B: 2 GHz, 0.8V

각 옵션에 대해 실행 시간, 동적 전력, 총 소비 에너지를 계산하십시오. 어느 옵션이 더 에너지 효율적입니까?

### 문제 3: 다크 실리콘 예산

5nm에서 100mm² 칩에는 200억 개의 트랜지스터가 있습니다. TDP는 15W(모바일)이고, 각 트랜지스터는 최대 활동 시 평균 0.5pW를 소비합니다.
1. 동시에 활성화할 수 있는 트랜지스터의 비율은 얼마입니까?
2. 3nm에서 이 값이 어떻게 변합니까 (1.5배 밀도, 동일 TDP 가정)?
3. 다크 실리콘 예산을 효과적으로 활용하는 이기종 설계를 제안하십시오.

### 문제 4: C-상태 분석

서버 코어가 2ms 연산과 8ms 유휴를 반복합니다. 사용 가능한 C-상태는 C1 (웨이크업 1μs, 유휴 전력 30% 절감), C3 (웨이크업 100μs, 70% 절감), C6 (웨이크업 500μs, 95% 절감)입니다. 각 유휴 기간 동안 OS는 어느 C-상태를 선택해야 합니까? 각 상태의 손익분기 시간을 고려하십시오.

### 문제 5: PUE와 총 비용

데이터 센터에서 10,000대 서버가 평균 300W씩 구동됩니다. PUE = 1.5. 전기 요금은 kWh당 $0.10입니다.
1. 연간 전기 요금을 계산하십시오.
2. PUE가 1.2로 개선되면 연간 절감액은 얼마입니까?
3. 3년 이내에 손익분기점에 도달하려면 냉각 개선에 얼마를 투자할 수 있습니까?

---

*20강 끝*
