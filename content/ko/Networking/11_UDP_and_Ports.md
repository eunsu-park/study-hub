# UDP와 포트

**이전**: [TCP 프로토콜](./10_TCP_Protocol.md) | **다음**: [DNS](./12_DNS.md)

---

## 학습 목표(Learning Objectives)

이 레슨을 완료하면 다음을 할 수 있습니다:

1. UDP의 특징을 설명하고, TCP와 어떻게 다른지 비교할 수 있습니다
2. UDP 헤더 필드를 해석하고 체크섬 계산 범위를 설명할 수 있습니다
3. 주어진 애플리케이션 시나리오에 적합한 전송 프로토콜(TCP vs UDP)을 선택할 수 있습니다
4. 전송 계층 연결 다중화(Multiplexing)에서 포트 번호의 역할을 설명할 수 있습니다
5. 잘 알려진 포트(Well-known), 등록된 포트(Registered), 동적/임시 포트(Dynamic/Ephemeral) 범위를 구분할 수 있습니다
6. 소켓(Socket)의 개념을 정의하고 5-튜플(5-tuple)의 구성 요소를 식별할 수 있습니다
7. 시스템 명령어(`ss`, `netstat`, `lsof`)를 사용하여 열린 포트와 소켓 상태를 확인할 수 있습니다

---

**난이도**: ⭐⭐
**예상 학습 시간**: 2시간
**선수 지식**: [10_TCP_Protocol.md](./10_TCP_Protocol.md)

> **비유 -- 엽서**: TCP가 배달 확인이 있는 등기 우편이라면, UDP는 엽서입니다. 메시지를 쓰고 우편함에 넣은 뒤 도착하기를 기다릴 뿐입니다. 추적도, 확인도, 순서 보장도 없습니다. 하지만 엽서는 빠르고 저렴합니다. 완벽함보다 속도가 중요한 상황 -- 라이브 동영상, 온라인 게임, DNS 조회 -- 에서는 UDP의 "쏘고 잊기(fire and forget)" 방식이 정답입니다.

모든 인터넷 애플리케이션은 데이터를 어떻게 전달할지 결정해야 합니다: 오버헤드를 감수하고 신뢰성 있게 보낼 것인지, 아니면 단순하고 빠르게 보낼 것인지입니다. UDP와 포트를 이해하는 것은 전송 계층의 나머지 절반 -- TCP의 빠르고 가벼운 상대방 -- 을 이해하는 데 필수적입니다. 포트는 단일 호스트에서 수십 개의 서비스가 동시에 실행되어 각각 고유한 주소로 도달 가능하게 하는 메커니즘입니다.

## 목차

1. [UDP의 특징](#1-udp의-특징)
2. [UDP 헤더 구조](#2-udp-헤더-구조)
3. [TCP vs UDP 비교](#3-tcp-vs-udp-비교)
4. [포트 번호의 개념](#4-포트-번호의-개념)
5. [포트 번호 범위](#5-포트-번호-범위)
6. [소켓](#6-소켓)
7. [연습 문제](#7-연습-문제)
8. [참고 자료](#8-참고-자료)

---

## 1. UDP의 특징

### 1.1 UDP 기본 개념

UDP(User Datagram Protocol)는 간단하고 빠른 전송을 위한 비연결형 프로토콜입니다.

```
┌─────────────────────────────────────────────────────────────────┐
│                       UDP 특징                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  1. 비연결 (Connectionless)                                     │
│     - 연결 설정/해제 과정 없음                                  │
│     - 핸드셰이크 없이 바로 데이터 전송                          │
│                                                                  │
│  2. 비신뢰성 (Unreliable)                                       │
│     - 전달 보장 없음                                            │
│     - 순서 보장 없음                                            │
│     - 재전송 없음                                               │
│                                                                  │
│  3. 빠른 전송 (Fast)                                            │
│     - 최소한의 오버헤드                                         │
│     - 연결 설정 지연 없음                                       │
│                                                                  │
│  4. 단순함 (Simple)                                             │
│     - 작은 헤더 (8 bytes)                                       │
│     - 상태 유지 불필요                                          │
│                                                                  │
│  5. 브로드캐스트/멀티캐스트 지원                                │
│     - 다수에게 동시 전송 가능                                   │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 1.2 UDP 동작 방식

```
UDP 데이터 전송

┌─────────────────┐                    ┌─────────────────┐
│     송신자      │                    │     수신자      │
│                 │                    │                 │
│  Application    │                    │  Application    │
│      │          │                    │      ▲          │
│      ▼          │                    │      │          │
│  ┌───────────┐  │                    │  ┌───────────┐  │
│  │   UDP     │  │     Datagram 1     │  │   UDP     │  │
│  │           │──┼────────────────────┼─►│           │  │
│  │ No state  │  │     Datagram 2     │  │ No state  │  │
│  │ No ACK    │──┼────────────────────┼─►│ No ACK    │  │
│  │           │  │     Datagram 3     │  │           │  │
│  │           │──┼─────────X (손실)   │  │           │  │
│  └───────────┘  │                    │  └───────────┘  │
│                 │                    │                 │
└─────────────────┘                    └─────────────────┘

특징:
- 각 데이터그램은 독립적
- 손실되어도 재전송 없음
- 애플리케이션이 신뢰성 처리
```

### 1.3 UDP 사용 사례

```
UDP가 적합한 경우:

┌─────────────────────────────────────────────────────────────────┐
│ 1. 실시간 스트리밍                                              │
│    - 동영상, 음성 통화 (VoIP)                                   │
│    - 약간의 패킷 손실보다 지연이 더 문제                        │
│                                                                  │
│ 2. 게임                                                         │
│    - 빠른 응답이 중요                                           │
│    - 예전 위치 정보는 의미 없음                                 │
│                                                                  │
│ 3. DNS 쿼리                                                     │
│    - 단일 요청/응답                                             │
│    - 연결 설정 오버헤드 불필요                                  │
│                                                                  │
│ 4. DHCP                                                         │
│    - 브로드캐스트 필요                                          │
│                                                                  │
│ 5. IoT / 센서 데이터                                            │
│    - 대량의 소규모 메시지                                       │
│    - 일부 손실 허용 가능                                        │
│                                                                  │
│ 6. SNMP (네트워크 관리)                                         │
│    - 간단한 요청/응답                                           │
└─────────────────────────────────────────────────────────────────┘
```

### 1.4 UDP의 장단점

| 장점 | 단점 |
|------|------|
| 빠른 전송 속도 | 전달 보장 없음 |
| 적은 오버헤드 | 순서 보장 없음 |
| 연결 설정 불필요 | 혼잡 제어 없음 |
| 멀티캐스트 지원 | 흐름 제어 없음 |
| 서버 부하 적음 | 보안 취약 (스푸핑) |

---

## 2. UDP 헤더 구조

### 2.1 UDP 헤더 형식

```
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|          Source Port          |       Destination Port        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|            Length             |           Checksum            |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                             Data                              |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

총 헤더 크기: 8 bytes (64 bits)
```

### 2.2 헤더 필드 설명

> **왜 필드가 4개뿐인가?** UDP의 설계 철학은 *최소한의 오버헤드(Overhead)로 최대한의 속도*를 내는 것입니다. TCP는 신뢰성 있는 순서 보장 전달을 위해 10개 이상의 필드(시퀀스 번호, 확인 응답, 윈도우 크기 등)가 필요합니다. UDP는 이 모든 것을 제거합니다. 대상 애플리케이션 -- DNS 쿼리, 라이브 비디오, 게임 -- 은 재전송(Retransmission)을 기다리느니 패킷을 버리는 쪽이 낫기 때문입니다. 8바이트 헤더는 한계가 아니라, 그 자체가 목적입니다.

| 필드 | 크기 | 설명 |
|------|------|------|
| Source Port | 16 bits | 송신자 포트 번호 (선택사항, 0 가능). 왜 선택사항인가? syslog 메시지처럼 응답이 필요 없는 단발성 요청에서는 이를 생략하여 임시 포트(Ephemeral Port) 할당을 절약할 수 있습니다. |
| Destination Port | 16 bits | 수신자 포트 번호. 데이터그램을 올바른 애플리케이션으로 역다중화(Demultiplex)하기 위해 OS가 *반드시* 필요로 하는 유일한 필드이며, 따라서 유일한 필수 주소 지정 필드입니다. |
| Length | 16 bits | UDP 헤더 + 데이터 전체 길이 (최소 8). IP가 이미 전체 길이를 가지고 있는데 왜 별도로 포함하는가? UDP 계층이 IP와 독립적으로 페이로드 경계를 검증할 수 있고, 유사 헤더(Pseudo-Header) 체크섬이 이 값을 사용해 데이터 잘림(Truncation)을 감지하기 때문입니다. |
| Checksum | 16 bits | 오류 검출 (IPv4에서 선택, IPv6에서 필수). IPv4에서 왜 선택사항인가? 초기 네트워크에서는 속도가 우선이었고, 일부 링크 계층이 이미 자체 체크섬을 제공했습니다. IPv6는 IP 계층 체크섬을 완전히 제거했으므로, UDP가 *스스로* 보호해야 합니다 -- 따라서 필수가 되었습니다. |

### 2.3 UDP 체크섬 계산

> **왜 유사 헤더(Pseudo-Header)를 포함하는가?** UDP 체크섬은 UDP 페이로드만 보호하는 것이 아니라, IP 헤더의 출발지/목적지 IP 주소까지 포함합니다. 이는 미묘하지만 위험한 장애를 감지하기 위함입니다: 라우터가 실수로 IP 주소를 변경하는 경우입니다. 유사 헤더 없이는 데이터그램이 잘못된 호스트에 "유효한" UDP 체크섬과 함께 전달될 수 있습니다. IP 주소를 계산에 포함시킴으로써, UDP 자체는 주소를 가지지 않지만 종단 간(End-to-End) 주소 무결성(Address Integrity)을 보장합니다.

```
UDP 체크섬은 Pseudo Header를 포함하여 계산

Pseudo Header (IPv4):
┌─────────────────────────────────────────────────────────────────┐
│                       Source IP Address                         │
├─────────────────────────────────────────────────────────────────┤
│                    Destination IP Address                       │
├────────────────┬─────────────────┬──────────────────────────────┤
│    Zero (8)    │  Protocol (17)  │        UDP Length            │
└────────────────┴─────────────────┴──────────────────────────────┘

체크섬 계산 범위:
1. Pseudo Header
2. UDP Header
3. UDP Data

목적:
- IP 헤더의 주소 정보가 변조되지 않았는지 확인
- 데이터 무결성 검증
```

### 2.4 UDP vs TCP 헤더 비교

> **이 크기 차이가 실제로 왜 중요한가?** 초당 100,000건의 쿼리를 처리하는 고빈도 DNS 리졸버(Resolver)에서, 패킷당 12바이트 이상의 절약(8 vs 20-60)은 초당 1 MB 이상의 대역폭(Bandwidth)을 실제 데이터를 위해 확보하는 효과를 냅니다. 매초 50바이트 측정값을 전송하는 IoT 센서의 경우, 20바이트 TCP 헤더는 40% 오버헤드가 되지만 UDP의 8바이트 헤더는 오버헤드를 16%로 유지합니다. 지연에 민감하고 높은 처리량이 필요한 프로토콜이 압도적으로 UDP를 선택하는 이유입니다.

```
TCP 헤더 (20-60 bytes):
┌────────────────────────────────────────────────────────────────┐
│ Src Port│Dst Port│  Seq Number  │  Ack Number  │Offset│Flags  │
│ Window  │Checksum│Urgent Pointer│    Options   │      │       │
└────────────────────────────────────────────────────────────────┘

UDP 헤더 (8 bytes):
┌────────────────────────────────────────────────────────────────┐
│ Src Port│Dst Port│   Length    │   Checksum   │               │
└────────────────────────────────────────────────────────────────┘

차이점:
- TCP: 시퀀스 번호, ACK, 플래그, 윈도우, 옵션 등 포함
- UDP: 최소한의 정보만 포함 (포트, 길이, 체크섬)
```

---

## 3. TCP vs UDP 비교

### 3.1 상세 비교표

| 특성 | TCP | UDP |
|------|-----|-----|
| 연결 방식 | 연결 지향 (3-way handshake) | 비연결 |
| 신뢰성 | 신뢰성 보장 (재전송) | 비신뢰성 (Best Effort) |
| 순서 | 순서 보장 (시퀀스 번호) | 순서 미보장 |
| 흐름 제어 | 슬라이딩 윈도우 | 없음 |
| 혼잡 제어 | Slow Start, AIMD 등 | 없음 |
| 헤더 크기 | 20-60 bytes | 8 bytes |
| 전송 단위 | Segment | Datagram |
| 통신 형태 | 1:1 | 1:1, 1:N, N:N |
| 속도 | 상대적 느림 | 빠름 |
| 오버헤드 | 높음 | 낮음 |

### 3.2 사용 시나리오 비교

```
┌─────────────────────────────────────────────────────────────────┐
│                      프로토콜 선택 기준                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  TCP 선택:                                                      │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │ • 데이터 무결성이 중요 (파일 전송, 이메일)               │  │
│  │ • 순서가 중요 (웹 페이지, 데이터베이스)                  │  │
│  │ • 연결 상태 관리 필요                                    │  │
│  │ • 재전송이 필수적                                        │  │
│  └───────────────────────────────────────────────────────────┘  │
│                                                                  │
│  UDP 선택:                                                      │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │ • 실시간성이 중요 (스트리밍, 게임)                       │  │
│  │ • 약간의 손실 허용 가능                                  │  │
│  │ • 단순한 요청/응답 (DNS)                                 │  │
│  │ • 브로드캐스트/멀티캐스트 필요                           │  │
│  │ • 자체 신뢰성 메커니즘 구현                              │  │
│  └───────────────────────────────────────────────────────────┘  │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 3.3 프로토콜별 주요 사용 예

```
┌─────────────────────────────────────────────────────────────────┐
│                          TCP 사용                                │
├───────────────────────────┬─────────────────────────────────────┤
│ HTTP/HTTPS (80/443)       │ 웹 브라우징                         │
│ FTP (20/21)               │ 파일 전송                           │
│ SMTP (25)                 │ 이메일 전송                         │
│ POP3 (110) / IMAP (143)   │ 이메일 수신                         │
│ SSH (22)                  │ 보안 원격 접속                      │
│ Telnet (23)               │ 원격 접속                           │
│ MySQL (3306)              │ 데이터베이스                        │
│ PostgreSQL (5432)         │ 데이터베이스                        │
└───────────────────────────┴─────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                          UDP 사용                                │
├───────────────────────────┬─────────────────────────────────────┤
│ DNS (53)                  │ 도메인 조회                         │
│ DHCP (67/68)              │ IP 자동 할당                        │
│ SNMP (161/162)            │ 네트워크 관리                       │
│ NTP (123)                 │ 시간 동기화                         │
│ TFTP (69)                 │ 간단한 파일 전송                    │
│ RTP                       │ 실시간 미디어 스트리밍              │
│ VoIP (SIP)                │ 인터넷 전화                         │
│ 온라인 게임               │ 실시간 게임 데이터                  │
└───────────────────────────┴─────────────────────────────────────┘
```

### 3.4 하이브리드 접근법

```
TCP와 UDP를 함께 사용하는 경우:

1. 게임
   ┌─────────────────────────────────────────────────────────────┐
   │  TCP: 로그인, 채팅, 인벤토리 (신뢰성 필요)                  │
   │  UDP: 캐릭터 이동, 실시간 전투 (속도 필요)                  │
   └─────────────────────────────────────────────────────────────┘

2. 스트리밍
   ┌─────────────────────────────────────────────────────────────┐
   │  TCP: 제어 채널 (재생/일시정지/볼륨)                        │
   │  UDP: 미디어 데이터 전송 (RTP)                              │
   └─────────────────────────────────────────────────────────────┘

3. QUIC (HTTP/3)
   ┌─────────────────────────────────────────────────────────────┐
   │  UDP 위에 신뢰성 계층 구현                                  │
   │  장점: 빠른 연결, HOL Blocking 해결                         │
   └─────────────────────────────────────────────────────────────┘
```

---

## 4. 포트 번호의 개념

### 4.1 포트의 역할

포트(Port)는 호스트 내에서 실행 중인 프로세스를 식별하는 번호입니다.

```
포트의 역할

┌─────────────────────────────────────────────────────────────────┐
│                          호스트                                  │
│                      192.168.1.100                              │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                                                          │    │
│  │  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐    │    │
│  │  │  Web    │  │  SSH    │  │  FTP    │  │  MySQL  │    │    │
│  │  │ Server  │  │ Server  │  │ Server  │  │ Server  │    │    │
│  │  │         │  │         │  │         │  │         │    │    │
│  │  └────┬────┘  └────┬────┘  └────┬────┘  └────┬────┘    │    │
│  │       │            │            │            │          │    │
│  │    Port 80     Port 22     Port 21     Port 3306       │    │
│  │       │            │            │            │          │    │
│  │       └────────────┴────────────┴────────────┘          │    │
│  │                         │                                │    │
│  │              ┌──────────┴──────────┐                    │    │
│  │              │    TCP/IP Stack     │                    │    │
│  │              └──────────┬──────────┘                    │    │
│  │                         │                                │    │
│  └─────────────────────────┼────────────────────────────────┘    │
│                            │                                      │
│                     Network Interface                             │
│                      192.168.1.100                                │
└─────────────────────────────┬─────────────────────────────────────┘
                              │
                          네트워크

각 패킷의 목적지 포트를 확인하여 해당 프로세스로 전달
```

### 4.2 소켓 주소

네트워크 통신에서 종단점은 IP 주소와 포트의 조합으로 식별됩니다.

```
소켓 주소 (Socket Address)

┌─────────────────────────────────────────────────────────────────┐
│                                                                  │
│  소켓 주소 = IP 주소 + 포트 번호                                │
│                                                                  │
│  예시:                                                          │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │  192.168.1.100:80    (웹 서버)                            │   │
│  │  10.0.0.5:443        (HTTPS 서버)                         │   │
│  │  192.168.1.50:50000  (클라이언트 임시 포트)               │   │
│  └──────────────────────────────────────────────────────────┘   │
│                                                                  │
│  TCP 연결의 고유 식별:                                          │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │  (Source IP, Source Port, Dest IP, Dest Port, Protocol)  │   │
│  │  = 5-tuple                                                │   │
│  └──────────────────────────────────────────────────────────┘   │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 4.3 포트 번호의 표기법

```
IPv4:
  IP:Port 형식
  예: 192.168.1.100:80

IPv6:
  [IP]:Port 형식 (대괄호로 IP 주소 감싸기)
  예: [2001:db8::1]:80
      [::1]:8080

URL에서:
  http://example.com:8080/path
  https://[2001:db8::1]:443/
```

---

## 5. 포트 번호 범위

### 5.1 포트 범위 분류

```
포트 번호 범위 (0 - 65535)

┌─────────────────────────────────────────────────────────────────┐
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  Well-known Ports (잘 알려진 포트)                       │    │
│  │  0 - 1023                                                │    │
│  │  • 시스템 서비스 및 표준 프로토콜                        │    │
│  │  • root/관리자 권한 필요                                 │    │
│  │  • IANA에서 관리                                         │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  Registered Ports (등록된 포트)                          │    │
│  │  1024 - 49151                                            │    │
│  │  • 특정 애플리케이션/서비스용                            │    │
│  │  • IANA에 등록 (필수는 아님)                             │    │
│  │  • 일반 사용자도 사용 가능                               │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  Dynamic/Private Ports (동적/사설 포트)                  │    │
│  │  49152 - 65535                                           │    │
│  │  • 임시 (Ephemeral) 포트                                 │    │
│  │  • 클라이언트 연결 시 자동 할당                          │    │
│  │  • 등록 불가                                             │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 5.2 주요 Well-known 포트

| 포트 | 프로토콜 | 서비스 | 설명 |
|------|----------|--------|------|
| 20 | TCP | FTP-Data | FTP 데이터 전송 |
| 21 | TCP | FTP-Control | FTP 제어 |
| 22 | TCP | SSH | 보안 쉘 |
| 23 | TCP | Telnet | 원격 접속 (비암호화) |
| 25 | TCP | SMTP | 이메일 전송 |
| 53 | TCP/UDP | DNS | 도메인 이름 서비스 |
| 67 | UDP | DHCP Server | IP 자동 할당 (서버) |
| 68 | UDP | DHCP Client | IP 자동 할당 (클라이언트) |
| 69 | UDP | TFTP | 간단한 파일 전송 |
| 80 | TCP | HTTP | 웹 (비암호화) |
| 110 | TCP | POP3 | 이메일 수신 |
| 123 | UDP | NTP | 시간 동기화 |
| 143 | TCP | IMAP | 이메일 수신 |
| 161 | UDP | SNMP | 네트워크 관리 |
| 443 | TCP | HTTPS | 웹 (암호화) |
| 445 | TCP | SMB | 파일 공유 (Windows) |
| 465 | TCP | SMTPS | SMTP over SSL |
| 514 | UDP | Syslog | 시스템 로그 |
| 993 | TCP | IMAPS | IMAP over SSL |
| 995 | TCP | POP3S | POP3 over SSL |

### 5.3 주요 Registered 포트

| 포트 | 프로토콜 | 서비스 | 설명 |
|------|----------|--------|------|
| 1433 | TCP | MSSQL | Microsoft SQL Server |
| 1521 | TCP | Oracle | Oracle Database |
| 3306 | TCP | MySQL | MySQL Database |
| 3389 | TCP | RDP | 원격 데스크톱 |
| 5432 | TCP | PostgreSQL | PostgreSQL Database |
| 5900 | TCP | VNC | 원격 데스크톱 |
| 6379 | TCP | Redis | Redis 캐시 |
| 8080 | TCP | HTTP-Alt | 대체 HTTP 포트 |
| 8443 | TCP | HTTPS-Alt | 대체 HTTPS 포트 |
| 9000 | TCP | Various | PHP-FPM 등 |
| 27017 | TCP | MongoDB | MongoDB Database |

### 5.4 임시 포트 (Ephemeral Ports)

```
클라이언트 연결 시 임시 포트 할당

┌─────────────────────────────────────────────────────────────────┐
│                                                                  │
│  클라이언트                        서버                         │
│  (192.168.1.10)                   (10.0.0.5)                    │
│                                                                  │
│  ┌─────────────┐                  ┌─────────────┐               │
│  │ 웹 브라우저 │                  │  웹 서버    │               │
│  │  Port: ?    │─────────────────►│  Port: 80   │               │
│  └─────────────┘                  └─────────────┘               │
│                                                                  │
│  OS가 임시 포트 자동 할당:                                      │
│  예: 192.168.1.10:52431 → 10.0.0.5:80                          │
│                                                                  │
│  운영체제별 임시 포트 범위:                                     │
│  ┌────────────────────────────────────────────────────────┐     │
│  │ Linux:   32768 - 60999 (net.ipv4.ip_local_port_range) │     │
│  │ Windows: 49152 - 65535                                 │     │
│  │ macOS:   49152 - 65535                                 │     │
│  │ BSD:     1024 - 5000 (구버전)                          │     │
│  └────────────────────────────────────────────────────────┘     │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 6. 소켓

### 6.1 소켓의 개념

소켓(Socket)은 네트워크 통신의 끝점(Endpoint)을 추상화한 것입니다.

```
소켓 통신 모델

┌─────────────────────────────────────────────────────────────────┐
│                                                                  │
│     Application                         Application             │
│         │                                    │                  │
│    ┌────┴────┐                          ┌────┴────┐             │
│    │ Socket  │                          │ Socket  │             │
│    │ API     │                          │ API     │             │
│    └────┬────┘                          └────┬────┘             │
│         │                                    │                  │
│    ┌────┴────┐                          ┌────┴────┐             │
│    │ Socket  │◄═════════════════════════│ Socket  │             │
│    │192.168. │    TCP/UDP Connection    │10.0.0.5 │             │
│    │1.10:5000│                          │:80      │             │
│    └─────────┘                          └─────────┘             │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘

소켓 = (프로토콜, IP 주소, 포트 번호)
```

### 6.2 소켓 타입

```
┌─────────────────────────────────────────────────────────────────┐
│                        소켓 타입                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  SOCK_STREAM (스트림 소켓)                                      │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │ • TCP 사용                                                │  │
│  │ • 연결 지향                                               │  │
│  │ • 신뢰성 있는 양방향 바이트 스트림                        │  │
│  │ • 순서 보장                                               │  │
│  └───────────────────────────────────────────────────────────┘  │
│                                                                  │
│  SOCK_DGRAM (데이터그램 소켓)                                   │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │ • UDP 사용                                                │  │
│  │ • 비연결                                                  │  │
│  │ • 고정 크기 메시지                                        │  │
│  │ • 순서/전달 보장 없음                                     │  │
│  └───────────────────────────────────────────────────────────┘  │
│                                                                  │
│  SOCK_RAW (로우 소켓)                                           │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │ • IP 계층 직접 접근                                       │  │
│  │ • 커스텀 프로토콜 구현                                    │  │
│  │ • root 권한 필요                                          │  │
│  │ • ping, traceroute 등에 사용                              │  │
│  └───────────────────────────────────────────────────────────┘  │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 6.3 TCP 소켓 프로그래밍 흐름

```
TCP 서버/클라이언트 흐름

       서버                              클라이언트
         │                                    │
    socket()                             socket()
         │                                    │
      bind()                                  │
         │                                    │
     listen()                                 │
         │                                    │
     accept() ◄─────── connect() ─────────────┤
         │         (3-way handshake)          │
         │                                    │
      read() ◄──────── write() ──────────────┤
         │                                    │
     write() ────────► read()                 │
         │                                    │
     close() ◄──────── close() ──────────────┤
                   (4-way handshake)

Python 예시 (서버):
```

```python
import socket

# 소켓 생성
server = socket.socket(socket.AF_INET, socket.SOCK_STREAM)

# 주소 바인딩
server.bind(('0.0.0.0', 8080))

# 연결 대기
server.listen(5)

# 클라이언트 연결 수락
client, addr = server.accept()
print(f"Connected: {addr}")

# 데이터 송수신
data = client.recv(1024)
client.send(b"Hello, Client!")

# 연결 종료
client.close()
server.close()
```

### 6.4 UDP 소켓 프로그래밍 흐름

```
UDP 서버/클라이언트 흐름

       서버                              클라이언트
         │                                    │
    socket()                             socket()
         │                                    │
      bind()                                  │
         │                                    │
   recvfrom() ◄────── sendto() ──────────────┤
         │                                    │
    sendto() ─────────► recvfrom()            │
         │                                    │
     close()                              close()

특징:
- connect() 불필요 (비연결)
- 각 메시지에 목적지 주소 포함
```

```python
import socket

# UDP 서버
server = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
server.bind(('0.0.0.0', 9999))

data, addr = server.recvfrom(1024)
print(f"From {addr}: {data}")
server.sendto(b"ACK", addr)
```

### 6.5 소켓 상태 확인

```bash
# Linux - 소켓 상태 확인
ss -tuln                    # TCP/UDP 리스닝 소켓
ss -tan                     # 모든 TCP 연결
ss -tan state established   # 연결된 TCP만

# netstat (구버전)
netstat -an | grep LISTEN
netstat -tunlp

# macOS
netstat -an | grep LISTEN
lsof -i -P | grep LISTEN

# Windows
netstat -an | findstr LISTEN
netstat -ano
```

---

## 7. 연습 문제

### 문제 1: TCP vs UDP 선택

다음 시나리오에 적합한 프로토콜을 선택하세요.

a) 은행 거래 시스템
b) 라이브 스트리밍 방송
c) 이메일 전송
d) 멀티플레이어 게임의 캐릭터 위치 동기화
e) 대용량 파일 다운로드
f) IoT 센서 데이터 수집 (1초마다)

### 문제 2: 포트 번호 매칭

다음 서비스와 기본 포트 번호를 연결하세요.

```
서비스:               포트:
a) HTTPS              1) 22
b) MySQL              2) 25
c) SMTP               3) 53
d) SSH                4) 443
e) DNS                5) 3306
```

### 문제 3: UDP 헤더 분석

다음 UDP 헤더(16진수)를 분석하세요.

```
01 BB 00 35 00 1C 8A 7E
```

a) Source Port는?
b) Destination Port는? (어떤 서비스?)
c) UDP Length는? (데이터 크기는?)
d) Checksum은?

### 문제 4: 소켓 식별

하나의 서버가 다음 요청을 동시에 처리하고 있습니다.

```
클라이언트 A: 192.168.1.10:50001 → 서버: 10.0.0.5:80
클라이언트 B: 192.168.1.10:50002 → 서버: 10.0.0.5:80
클라이언트 C: 192.168.1.20:50001 → 서버: 10.0.0.5:80
```

a) 서버는 이 세 연결을 어떻게 구분하나요?
b) 5-tuple을 사용하여 각 연결을 표현하세요.

---

## 정답

### 문제 1 정답

a) 은행 거래 → **TCP** (신뢰성 필수)
b) 라이브 스트리밍 → **UDP** (실시간성 중요, 일부 손실 허용)
c) 이메일 전송 → **TCP** (데이터 무결성 필요)
d) 게임 캐릭터 위치 → **UDP** (실시간, 최신 데이터만 의미 있음)
e) 파일 다운로드 → **TCP** (완전한 데이터 필요)
f) IoT 센서 데이터 → **UDP** (빈번한 소규모 메시지, 일부 손실 허용)

### 문제 2 정답

- a) HTTPS → 4) 443
- b) MySQL → 5) 3306
- c) SMTP → 2) 25
- d) SSH → 1) 22
- e) DNS → 3) 53

### 문제 3 정답

```
01 BB 00 35 00 1C 8A 7E

a) Source Port: 0x01BB = 443 (HTTPS)
b) Destination Port: 0x0035 = 53 (DNS)
c) UDP Length: 0x001C = 28 bytes
   데이터 크기: 28 - 8 = 20 bytes
d) Checksum: 0x8A7E
```

### 문제 4 정답

a) 서버는 **5-tuple**로 각 연결을 구분합니다:
   (Protocol, Src IP, Src Port, Dst IP, Dst Port)

b) 5-tuple 표현:
   - 클라이언트 A: (TCP, 192.168.1.10, 50001, 10.0.0.5, 80)
   - 클라이언트 B: (TCP, 192.168.1.10, 50002, 10.0.0.5, 80)
   - 클라이언트 C: (TCP, 192.168.1.20, 50001, 10.0.0.5, 80)

   세 연결 모두 Src IP 또는 Src Port가 다르므로 고유하게 식별됩니다.

---

## 8. 참고 자료

### RFC 문서

- RFC 768 - User Datagram Protocol
- RFC 793 - Transmission Control Protocol
- RFC 6335 - Internet Assigned Numbers Authority (IANA) Procedures

### 명령어 참고

```bash
# 포트 확인 (Linux)
ss -tuln                     # 리스닝 포트
ss -tan state established    # 연결된 소켓
lsof -i :80                  # 특정 포트 사용 프로세스

# 포트 확인 (macOS)
netstat -an | grep LISTEN
lsof -iTCP -sTCP:LISTEN

# 포트 확인 (Windows)
netstat -an | findstr LISTENING
netstat -ano | findstr :80

# 포트 스캔
nmap -p 1-1000 target_ip     # TCP 포트 스캔
nmap -sU -p 53,67,123 target # UDP 포트 스캔

# UDP 테스트
nc -u target_ip 53           # UDP 연결 테스트
```

### 학습 자료

- [IANA Port Number Registry](https://www.iana.org/assignments/service-names-port-numbers/)
- [RFC 768 - UDP](https://tools.ietf.org/html/rfc768)
- Unix Network Programming - W. Richard Stevens

---

**이전**: [TCP 프로토콜](./10_TCP_Protocol.md) | **다음**: [DNS](./12_DNS.md)
