[이전: 서비스 품질](./21_Quality_of_Service.md)

---

# 22. 멀티캐스트(Multicast)

## 학습 목표

이 레슨을 마치면 다음을 할 수 있습니다:

1. 유니캐스트(unicast), 브로드캐스트(broadcast), 멀티캐스트(multicast) 주소 지정의 차이를 설명한다
2. 그룹 멤버십 관리를 위한 IGMP(v1/v2/v3) 동작을 설명한다
3. PIM 스파스 모드(Sparse Mode)와 덴스 모드(Dense Mode)로 멀티캐스트 라우팅을 구현한다
4. 멀티캐스트 IP 주소를 이더넷 MAC 주소에 매핑한다
5. 실제 시나리오(라이브 스트리밍, 금융 데이터, IPTV)에 멀티캐스트를 적용한다

---

## 목차

1. [멀티캐스트 기초](#1-멀티캐스트-기초)
2. [멀티캐스트 주소 지정](#2-멀티캐스트-주소-지정)
3. [IGMP: 그룹 멤버십](#3-igmp-그룹-멤버십)
4. [멀티캐스트 라우팅 프로토콜](#4-멀티캐스트-라우팅-프로토콜)
5. [소스별 멀티캐스트(SSM)](#5-소스별-멀티캐스트ssm)
6. [애플리케이션](#6-애플리케이션)
7. [연습문제](#7-연습문제)

---

## 1. 멀티캐스트 기초

### 1.1 유니캐스트 vs 브로드캐스트 vs 멀티캐스트

```
유니캐스트 (일대일):
  소스 ──────► 수신자 A
  소스 ──────► 수신자 B    네트워크에 3개의 복사본
  소스 ──────► 수신자 C

브로드캐스트 (일대전체):
  소스 ──────► 모든 장치   관심 없는 장치도 포함
                           대역폭 낭비

멀티캐스트 (일대다):
  소스 ──────┬──► 수신자 A (관심 있음)
              ├──► 수신자 C (관심 있음)
              │
              ✗    수신자 B (관심 없음, 전송 안 됨)

  링크당 하나의 복사본만 전송.
  네트워크가 분기점에서 복제합니다.
```

### 1.2 왜 멀티캐스트인가?

| 시나리오 | 유니캐스트 | 멀티캐스트 | 절약 |
|---------|-----------|-----------|------|
| 1000명 시청자에게 라이브 비디오 | 1000 스트림 × 5 Mbps = 5 Gbps | 1 스트림 × 5 Mbps = 5 Mbps | 1000배 |
| 500명 트레이더에게 주식 데이터 | 500 × 100 Kbps = 50 Mbps | 1 × 100 Kbps = 100 Kbps | 500배 |
| 10,000대 컴퓨터에 OS 업데이트 | 10,000 × 2 GB = 20 TB 전송 | 1 × 2 GB = 2 GB | 10,000배 |

### 1.3 멀티캐스트 전달 모델

```
멀티캐스트 트리:

        소스
          │
          ▼
      ┌───────┐
      │라우터  │ (루트)
      │   A   │
      └───┬───┘
          │
     ┌────┴────┐
     ▼         ▼
  ┌──────┐  ┌──────┐
  │라우터│  │라우터│
  │  B   │  │  C   │
  └──┬───┘  └──┬───┘
     │         │
  ┌──┴──┐   ┌─┴──┐
  ▼     ▼   ▼    ▼
 R1    R2  R3   R4     수신자 (그룹 멤버)

소스의 패킷 하나 → 라우터 B와 C에서 복제됩니다.
R1-R4 모두 동일한 스트림을 수신합니다.
```

---

## 2. 멀티캐스트 주소 지정

### 2.1 IPv4 멀티캐스트 주소

클래스 D 주소: 224.0.0.0 – 239.255.255.255

```
예약된 범위:
  224.0.0.0/24     — 로컬 네트워크 제어 (TTL=1, 포워딩 안 됨)
    224.0.0.1      — 이 서브넷의 모든 호스트
    224.0.0.2      — 이 서브넷의 모든 라우터
    224.0.0.5      — OSPF 라우터
    224.0.0.6      — OSPF 지정 라우터
    224.0.0.13     — PIM 라우터

  224.0.1.0/24     — 인터네트워크 제어
  232.0.0.0/8      — 소스별 멀티캐스트(SSM)
  239.0.0.0/8      — 관리 범위 (비공개, RFC 1918과 유사)
```

### 2.2 IP에서 MAC 매핑

```python
def multicast_ip_to_mac(ip_address):
    """멀티캐스트 IP를 이더넷 MAC 주소로 변환.

    규칙: MAC = 01:00:5E + IP 주소의 하위 23비트.
    참고: IP의 5비트가 손실됨 → 32개의 IP가 1개의 MAC을 공유.

    예시: 239.1.2.3
      IP 바이너리: 11101111.00000001.00000010.00000011
      하위 23비트:          0.00000001.00000010.00000011
      MAC: 01:00:5E:01:02:03
    """
    octets = [int(x) for x in ip_address.split('.')]
    # 하위 23비트: 두 번째 옥텟의 최상위 비트 제거
    mac = f"01:00:5E:{octets[1] & 0x7F:02X}:{octets[2]:02X}:{octets[3]:02X}"
    return mac
```

### 2.3 IPv6 멀티캐스트

```
IPv6 멀티캐스트: FF00::/8

  FF02::1    — 모든 노드 (링크-로컬)
  FF02::2    — 모든 라우터 (링크-로컬)
  FF02::5    — OSPF 라우터
  FF02::9    — RIP 라우터
  FF02::FB   — mDNS
  FF05::2    — 모든 라우터 (사이트-로컬)

IPv6 MAC 매핑:
  MAC = 33:33 + IPv6 멀티캐스트 주소의 하위 32비트
  예시: FF02::1 → 33:33:00:00:00:01
```

---

## 3. IGMP: 그룹 멤버십

### 3.1 IGMP 개요

IGMP(Internet Group Management Protocol, 인터넷 그룹 관리 프로토콜)는 호스트와 로컬 라우터 간의 멀티캐스트 그룹 멤버십을 관리합니다.

```
IGMP 통신:

  호스트 A              라우터              호스트 B
    │                     │                    │
    │── IGMP Report ────►│                    │
    │   "239.1.1.1 참가" │                    │
    │                     │                    │
    │                     │◄── IGMP Report ───│
    │                     │  "239.1.1.1 참가"  │
    │                     │                    │
    │                     │  라우터가 인식:     │
    │                     │  239.1.1.1 에      │
    │                     │  이 인터페이스에   │
    │                     │  멤버가 있음        │
    │                     │                    │
    │◄─ 멀티캐스트 데이터 │──────────────────►│
    │   239.1.1.1용      │   239.1.1.1용      │
    │                     │                    │
    │── IGMP Leave ─────►│                    │
    │   "239.1.1.1 탈퇴" │                    │
    │                     │                    │
    │                     │── IGMP Query ────►│
    │                     │  "239.1.1.1에      │
    │                     │   아직 있는 사람?" │
    │                     │                    │
    │                     │◄── IGMP Report ───│
    │                     │  "아직 여기 있음"  │
```

### 3.2 IGMP 버전

| 기능 | IGMPv1 | IGMPv2 | IGMPv3 |
|------|--------|--------|--------|
| 탈퇴 메커니즘 | 타임아웃만 | 명시적 탈퇴 | 명시적 탈퇴 |
| 그룹별 쿼리 | 없음 | 있음 | 있음 |
| 소스 필터링 | 없음 | 없음 | 있음 (포함/제외) |
| 쿼리어 선출 | 없음 | 있음 | 있음 |
| SSM 지원 | 없음 | 없음 | 있음 |

### 3.3 IGMP 스누핑(IGMP Snooping)

스위치는 멀티캐스트 그룹 멤버가 있는 포트를 학습하고, 모든 포트에 플러딩하는 대신 해당 포트에만 멀티캐스트를 전달합니다:

```python
class IGMPSnoopingSwitch:
    """IGMP 스누핑: 레이어 2에서 멀티캐스트 포워딩 최적화.

    스누핑 없이: 멀티캐스트가 모든 포트에 플러딩됨 (비효율).
    스누핑으로: 멀티캐스트가 관심 있는 포트에만 전송됨.
    """

    def __init__(self, num_ports):
        self.num_ports = num_ports
        # group_address → 멤버가 있는 포트 집합
        self.group_table = {}
        self.router_ports = set()  # 라우터와 연결된 포트

    def handle_igmp_report(self, port, group):
        """이 포트의 호스트가 멀티캐스트 그룹에 참가."""
        if group not in self.group_table:
            self.group_table[group] = set()
        self.group_table[group].add(port)

    def handle_igmp_leave(self, port, group):
        """이 포트의 호스트가 멀티캐스트 그룹에서 탈퇴."""
        if group in self.group_table:
            self.group_table[group].discard(port)
            if not self.group_table[group]:
                del self.group_table[group]

    def forward_multicast(self, ingress_port, group):
        """멀티캐스트를 포워딩할 포트 결정."""
        ports = set()

        # 항상 라우터 포트로 포워딩
        ports.update(self.router_ports)

        # 그룹 멤버가 있는 포트로 포워딩
        if group in self.group_table:
            ports.update(self.group_table[group])

        # 수신 포트로는 다시 보내지 않음
        ports.discard(ingress_port)
        return ports
```

---

## 4. 멀티캐스트 라우팅 프로토콜

### 4.1 PIM 덴스 모드(PIM-DM, PIM Dense Mode)

플러드-앤-프룬(flood-and-prune): 모든 곳에 멀티캐스트를 전송한 후 수신자가 없는 분기를 가지치기합니다.

```
PIM 덴스 모드:

1단계: 전체 플러딩
  소스 → 모든 라우터가 트래픽을 수신

2단계: 하위 수신자가 없는 분기 가지치기
  하위 수신자가 없는 라우터가 상위로 Prune 메시지 전송

3단계: 결과 = 소스 기반 트리 (최단 경로 트리)
  수신자가 있는 분기만 남음

문제: 초기 플러딩으로 대역폭 낭비.
사용 사례: 대부분의 서브넷에 수신자가 있는 밀집 네트워크.
```

### 4.2 PIM 스파스 모드(PIM-SM, PIM Sparse Mode)

수신자가 명시적으로 참가하며, 트래픽은 요청된 곳에만 흐릅니다.

```
PIM 스파스 모드:

  1. 수신자가 IGMP 참가 전송
  2. 라우터가 랑데부 포인트(RP, Rendezvous Point)를 향해 PIM 참가 전송
  3. 소스가 RP에 등록
  4. RP가 공유 트리를 통해 트래픽 전달

      소스                    RP
        │                       │
        │── Register ─────────►│
        │                       │
        │   공유 트리:           │
        │                    ┌──┴──┐
        │                    │     │
        │                   R1    R2
        │                    │     │
        │                  수신1  수신2

  5. 선택적: 고대역폭 소스를 위해
     최단 경로 트리(SPT)로 전환
```

### 4.3 PIM-SM 주요 개념

| 개념 | 설명 |
|------|------|
| 랑데부 포인트(RP, Rendezvous Point) | 그룹 내 모든 멀티캐스트 트리의 공유 루트 |
| 공유 트리 (*, G) | RP에 루트를 둔 트리, 그룹 G의 모든 소스가 공유 |
| 최단 경로 트리 (S, G) | 소스 S에 루트를 둔 트리, 수신자까지 최적화된 경로 |
| SPT 전환 | 수신자 트래픽이 임계값을 초과하면 공유 트리에서 SPT로 전환 |
| RP 선출 | 정적 설정, Auto-RP (Cisco), 또는 BSR (표준) |

---

## 5. 소스별 멀티캐스트(SSM)

### 5.1 동기

표준 멀티캐스트(ASM, Any-Source Multicast)는 어떤 소스도 그룹에 전송할 수 있습니다. 이는 보안 우려(누구나 트래픽을 주입할 수 있음)를 만들고 RP 인프라를 필요로 합니다.

SSM: 수신자가 그룹과 소스를 모두 지정합니다.

```
ASM (임의 소스 멀티캐스트, Any-Source Multicast):
  Join(G)         — "임의 소스에서 그룹 G의 트래픽을 원함"
  보안 위험: 누구나 그룹 G에 전송 가능

SSM (소스별 멀티캐스트, Source-Specific Multicast):
  Join(S, G)      — "소스 S에서만 그룹 G의 트래픽을 원함"
  RP 불필요, 원하지 않는 소스 없음

  SSM 범위: 232.0.0.0/8 (IPv4)
```

### 5.2 SSM 장점

- 랑데부 포인트(RP) 불필요 (더 단순한 인프라)
- 수신자가 수신할 소스를 제어
- 소스 등록 불필요
- 더 나은 보안 (소스 검증)
- IGMPv3와 잘 호환

---

## 6. 애플리케이션

### 6.1 라이브 비디오 스트리밍 (IPTV)

```
IPTV 아키텍처:

  콘텐츠 ─────► 인코더 ─────► 멀티캐스트 ─────► DSLAM/OLT ─────► STB
  소스                        네트워크                           (TV)

  각 TV 채널 = 하나의 멀티캐스트 그룹
  채널 변경 = IGMP 탈퇴(이전 채널) + IGMP 참가(새 채널)
  채널 전환 시간: < 2초 (탈퇴 + 참가 + 비디오 디코딩)
```

### 6.2 금융 시장 데이터

```
증권 거래소 멀티캐스트:

  거래소 ──► 멀티캐스트 피드 ──► 트레이딩 회사

  장점:
    • 마이크로초 지연 (TCP 핸드셰이크 없음)
    • 공정: 모든 회사가 동시에 데이터 수신
    • 효율적: 하나의 스트림이 수천 명의 클라이언트 서비스
    • 신뢰성 있는 멀티캐스트 (PGM/NORM)로 갭 감지

  시장 데이터 그룹:
    239.1.1.1  — 주식 레벨 1 (최우수 매수/매도호가)
    239.1.1.2  — 주식 레벨 2 (전체 주문 장부)
    239.1.2.1  — 옵션 체인
    239.1.3.1  — 선물
```

### 6.3 멀티캐스트 DNS (mDNS)

```
로컬 서비스 탐색을 위한 mDNS:

  쿼리:  "printer._ipp._tcp.local" → 224.0.0.251 (mDNS 그룹)
  LAN의 모든 장치가 쿼리를 수신합니다.
  프린터가 IP 주소로 응답합니다.

  사용: Bonjour (Apple), Avahi (Linux)
  또한: Chromecast 탐색, IoT 장치 탐색
```

---

## 7. 연습문제

### 연습문제 1: IP에서 MAC 매핑

멀티캐스트 IP를 MAC 주소로 변환하는 기능을 구현하세요:
1. 다음 IP를 변환: 239.1.2.3, 224.0.0.5, 232.10.20.30, 239.128.1.1
2. 동일한 MAC에 매핑되는 두 멀티캐스트 IP를 찾으세요
3. 32개의 IP 주소가 1개의 MAC을 공유하는 이유와 스위치가 이를 처리하는 방법 설명
4. 역변환 구현: 주어진 MAC에 대해 어떤 IP 범위가 해당될 수 있는지 확인

### 연습문제 2: IGMP 스누핑 시뮬레이션

IGMP 스누핑 스위치를 구축하세요:
1. 8포트 스위치, 포트 8은 라우터에 연결
2. 시뮬레이션: 포트 1-4의 호스트가 시간에 따라 그룹 참가/탈퇴
3. 각 멀티캐스트 패킷에 대해 수신할 포트 표시
4. 스누핑 있을 때와 없을 때 사용된 대역폭 비교

### 연습문제 3: PIM-SM 공유 트리

PIM 스파스 모드 트리 구축을 시뮬레이션하세요:
1. RP가 하나인 6개 라우터 토폴로지 생성
2. 다른 시간에 수신자들이 그룹 239.1.1.1에 참가
3. 참가가 RP를 향해 전파될 때 공유 트리 (*, G) 구축
4. 소스가 RP에 등록되고 트래픽이 공유 트리를 따라 흐름
5. 각 단계에서 트리 시각화

### 연습문제 4: 멀티캐스트 트래픽 생성기

멀티캐스트 송신자와 수신자를 구축하세요:
1. 송신자: 시뮬레이션된 비디오 프레임 생성 (1 KB, 초당 30 프레임)
2. 수신자: 그룹 참가, 프레임 수신, 지터 및 손실 계산
3. 설정 가능한 지연 및 드롭 속도로 네트워크 시뮬레이션
4. 네트워크 손실률에 따른 수신 프레임율 그래프

### 연습문제 5: SSM vs ASM 비교

임의 소스 멀티캐스트와 소스별 멀티캐스트를 비교하세요:
1. ASM 시나리오: 3개 소스, 5개 수신자, RP 기반 트리
2. SSM 시나리오: 수신자가 소스를 지정, RP 없음
3. 시뮬레이션: 원치 않는 소스가 트래픽 주입 시도
4. 두 방식의 트리 설정 시간 및 대역폭 효율성 측정
5. 논의: ASM이 여전히 SSM보다 선호되는 경우는 언제인가?

---

*레슨 22 끝*
