# 기타 애플리케이션 프로토콜

**이전**: [HTTP와 HTTPS](./13_HTTP_and_HTTPS.md) | **다음**: [네트워크 보안 기초](./15_Network_Security_Basics.md)

---

## 학습 목표(Learning Objectives)

이 레슨을 마치면 다음을 할 수 있습니다:

1. DHCP DORA 과정을 설명하고 IP 주소가 임대(Lease)되고 갱신되는 방법을 기술할 수 있다
2. FTP 능동(Active) 모드와 수동(Passive) 모드를 비교하고 방화벽 측면의 영향을 식별할 수 있다
3. SMTP, POP3, IMAP를 구분하고 이메일 전송에서 각각의 역할을 설명할 수 있다
4. SSH 공개키 인증(Public Key Authentication)을 설명하고 터널링(Tunneling) 활용 사례를 제시할 수 있다
5. Telnet이 왜 보안에 취약한지 설명하고 SSH를 그 대안으로 제시할 수 있다
6. WebSocket의 양방향(Bidirectional) 통신과 HTTP 요청-응답 방식을 비교하고 업그레이드 핸드셰이크(Upgrade Handshake)를 설명할 수 있다
7. 주요 응용 계층 프로토콜의 기본 포트 번호를 기억할 수 있다

---

**난이도**: ⭐⭐

인터넷은 웹 페이지 그 이상으로 돌아갑니다. 노트북이 IP 주소를 받을 때, 이메일을 보낼 때, 파일을 전송하거나 원격 터미널을 열 때마다, 전문화된 응용 계층 프로토콜이 동작하고 있습니다. 이 레슨에서는 HTTP 이외에 가장 중요한 프로토콜들 -- 일상적인 네트워크 작업을 가능하게 하는 프로토콜들 -- 을 살펴봅니다.

> **적재적소의 도구(Right Tool for the Job)**: 이 레슨의 각 프로토콜은 HTTP가 처리할 수 없는(또는 처리해서는 안 되는) 특정 통신 문제를 해결하기 위해 존재합니다. DHCP는 *"장치가 아직 주소가 없을 때 어떻게 네트워크에 참여하는가?"*를 해결합니다. FTP는 *"디렉토리 탐색과 함께 대용량 파일을 효율적으로 전송하는 방법은?"*을 해결합니다. SMTP/POP3/IMAP은 *"오프라인일 수 있는 수신자에게 불안정한 링크를 통해 비동기적으로 메시지를 전달하는 방법은?"*을 해결합니다. SSH는 *"모든 키 입력이 중요한 상황에서 원격 머신을 안전하게 운영하는 방법은?"*을 해결합니다. WebSocket은 *"끊임없는 폴링(Polling) 없이 서버 이벤트를 실시간으로 클라이언트에 전달하는 방법은?"*을 해결합니다. 각 프로토콜이 해결하는 *문제*를 이해하면 어떤 것을 선택해야 하는지, 그리고 다른 대안이 왜 부족한지 쉽게 기억할 수 있습니다.

## 목차

1. [DHCP](#1-dhcp)
2. [FTP](#2-ftp)
3. [이메일 프로토콜](#3-이메일-프로토콜)
4. [SSH](#4-ssh)
5. [Telnet](#5-telnet)
6. [WebSocket](#6-websocket)
7. [연습 문제](#7-연습-문제)
8. [참고 자료](#8-참고-자료)

---

## 1. DHCP

### DHCP 개요

DHCP(Dynamic Host Configuration Protocol)는 네트워크에 연결된 장치에 IP 주소와 네트워크 설정을 자동으로 할당하는 프로토콜입니다.

```
┌─────────────────────────────────────────────────────────────────┐
│                      DHCP 기본 개념                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  포트: UDP 67 (서버), UDP 68 (클라이언트)                        │
│  RFC: 2131                                                      │
│                                                                 │
│  할당 정보:                                                     │
│  - IP 주소                                                      │
│  - 서브넷 마스크                                                │
│  - 기본 게이트웨이                                              │
│  - DNS 서버                                                     │
│  - 임대 시간 (Lease Time)                                       │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### DHCP DORA 과정

```
┌─────────────────────────────────────────────────────────────────┐
│                    DHCP DORA 과정                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  [클라이언트]                            [DHCP 서버]             │
│   (IP 없음)                              (192.168.1.1)          │
│      │                                        │                 │
│      │──(1) DHCP Discover ─────────────────▶ │                 │
│      │     출발지: 0.0.0.0                   │                 │
│      │     목적지: 255.255.255.255 (브로드캐스트)                │
│      │     "IP 주소가 필요합니다"             │                 │
│      │                                        │                 │
│      │◀─(2) DHCP Offer ─────────────────────│                 │
│      │     "192.168.1.100을 제안합니다"       │                 │
│      │     서브넷: 255.255.255.0             │                 │
│      │     게이트웨이: 192.168.1.1           │                 │
│      │     DNS: 8.8.8.8                      │                 │
│      │     임대 시간: 24시간                  │                 │
│      │                                        │                 │
│      │──(3) DHCP Request ──────────────────▶ │                 │
│      │     "192.168.1.100을 요청합니다"       │                 │
│      │                                        │                 │
│      │◀─(4) DHCP Ack ───────────────────────│                 │
│      │     "192.168.1.100 사용을 승인합니다"  │                 │
│      │                                        │                 │
│  [IP 설정 완료]                               │                 │
│  (192.168.1.100)                              │                 │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘

DORA: Discover → Offer → Request → Acknowledge
```

### DHCP 메시지 유형

| 메시지 | 방향 | 설명 |
|--------|------|------|
| DISCOVER | 클라이언트 → 서버 | IP 주소 요청 (브로드캐스트) |
| OFFER | 서버 → 클라이언트 | IP 주소 제안 |
| REQUEST | 클라이언트 → 서버 | 제안 수락 또는 갱신 요청 |
| ACK | 서버 → 클라이언트 | 요청 승인 |
| NAK | 서버 → 클라이언트 | 요청 거부 |
| RELEASE | 클라이언트 → 서버 | IP 반납 |
| INFORM | 클라이언트 → 서버 | 추가 설정 요청 |

### DHCP 임대 과정

```
┌─────────────────────────────────────────────────────────────────┐
│                    DHCP 임대 시간                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  임대 시작                                                      │
│      │                                                          │
│      ├────────────────────────────────────── 임대 시간 (T)       │
│      │                                                          │
│      ├──────────────── T/2 (50%)                                │
│      │                 │                                        │
│      │                 └─ 갱신 시도 (Request to 서버)            │
│      │                    성공 시: 임대 시간 연장                 │
│      │                                                          │
│      ├──────────────────────────── T * 7/8 (87.5%)              │
│      │                             │                            │
│      │                             └─ 리바인딩 시도               │
│      │                                (브로드캐스트)             │
│      │                                                          │
│      └────────────────────────────────────── T (100%)           │
│                                              │                  │
│                                              └─ 임대 만료        │
│                                                 IP 해제         │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### DHCP 관련 명령어

```bash
# Linux - DHCP 클라이언트
# IP 해제
sudo dhclient -r eth0

# IP 갱신
sudo dhclient eth0

# 상세 정보 출력
sudo dhclient -v eth0

# Windows
ipconfig /release     # IP 해제
ipconfig /renew       # IP 갱신

# macOS
sudo ipconfig set en0 DHCP    # DHCP 재설정
```

---

## 2. FTP

### FTP 개요

FTP(File Transfer Protocol)는 클라이언트와 서버 간에 파일을 전송하기 위한 프로토콜입니다.

```
┌─────────────────────────────────────────────────────────────────┐
│                      FTP 기본 정보                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  포트:                                                          │
│  - 제어 연결: TCP 21                                            │
│  - 데이터 연결: TCP 20 (Active) 또는 임의 포트 (Passive)         │
│                                                                 │
│  특징:                                                          │
│  - 두 개의 채널 사용 (제어 + 데이터)                             │
│  - 평문 전송 (보안 취약)                                         │
│  - ASCII/Binary 전송 모드                                       │
│  - Active/Passive 모드                                          │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### FTP Active vs Passive 모드

```
┌─────────────────────────────────────────────────────────────────┐
│                    Active 모드                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  [클라이언트]                              [FTP 서버]            │
│  (임의 포트 N)                              (포트 21, 20)        │
│      │                                        │                 │
│      │──(1) 제어 연결 (N → 21) ────────────▶ │                 │
│      │      "PORT N+1"                       │                 │
│      │                                        │                 │
│      │◀─(2) 데이터 연결 (20 → N+1) ──────────│                 │
│      │      서버가 클라이언트로 연결          │                 │
│      │                                        │                 │
│  ※ 클라이언트 방화벽이 외부 연결 차단 시 문제 발생                │
│                                                                 │
├─────────────────────────────────────────────────────────────────┤
│                    Passive 모드                                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  [클라이언트]                              [FTP 서버]            │
│  (임의 포트)                               (포트 21, 임의 포트)  │
│      │                                        │                 │
│      │──(1) 제어 연결 (N → 21) ────────────▶ │                 │
│      │      "PASV"                           │                 │
│      │                                        │                 │
│      │◀──── 응답: 포트 P 사용 ───────────────│                 │
│      │                                        │                 │
│      │──(2) 데이터 연결 (N+1 → P) ──────────▶ │                 │
│      │      클라이언트가 서버로 연결          │                 │
│      │                                        │                 │
│  ※ 클라이언트가 항상 연결 시작 → 방화벽 문제 적음                 │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### FTP 주요 명령어

> **왜 FTP는 바이너리 옵코드(Binary Opcode) 대신 별도의 텍스트 명령어를 사용하는가?** FTP는 1970년대 초에 설계되었으며, 사람이 읽을 수 있는 프로토콜이 디버깅을 쉽게 했습니다 -- 말 그대로 포트 21에 텔넷으로 접속해서 명령어를 입력할 수 있었습니다. 이 텍스트 기반 제어 채널(Control Channel)은 스크립팅과 자동화도 매우 쉽게 만들어 줍니다. 대가로 장황함이 있지만, 제어 메시지는 파일 데이터에 비해 매우 작으므로 거의 영향이 없습니다.

| 명령 | 설명 | 예시 |
|------|------|------|
| USER | 사용자명 전송 -- 인증(Authentication) 핸드셰이크를 시작; 서버는 접근 권한 부여 전에 신원을 확인해야 함 | `USER username` |
| PASS | 비밀번호 전송 -- 인증을 완료; 평문(Plaintext)으로 전송되므로 오늘날에는 SFTP가 권장됨 | `PASS password` |
| LIST | 디렉토리 목록 -- 다운로드 전에 원격 파일을 탐색할 수 있게 함 | `LIST` |
| CWD | 디렉토리 변경 -- 원격 파일시스템을 탐색; FTP는 셸(Shell)을 모방하여 사용자가 탐색 가능 | `CWD /home/user` |
| PWD | 현재 디렉토리 -- CWD 후 현재 위치를 확인하여 잘못된 경로에 업로드하는 실수를 방지 | `PWD` |
| RETR | 파일 다운로드 -- 데이터 연결을 통해 서버에서 클라이언트로 "검색(Retrieve)" | `RETR file.txt` |
| STOR | 파일 업로드 -- 클라이언트에서 서버로 "저장(Store)"; RETR의 보완 명령 | `STOR file.txt` |
| DELE | 파일 삭제 -- 셸 없이 원격 파일 관리 | `DELE file.txt` |
| MKD | 디렉토리 생성 -- 업로드 전 원격 파일 구조를 정리 | `MKD newdir` |
| RMD | 디렉토리 삭제 -- 원격 구조를 정리 | `RMD olddir` |
| PASV | Passive 모드 -- 서버가 역으로 연결하는 대신 대기하도록 지시; 클라이언트가 인바운드 연결을 수락할 수 없는 NAT/방화벽(Firewall) 문제를 해결 | `PASV` |
| PORT | Active 모드 -- 데이터 전송을 위해 클라이언트가 어떤 포트에서 대기하는지 서버에 알림; 공인 IP가 있고 방화벽이 없는 경우에만 동작 | `PORT 192,168,1,100,4,1` |
| QUIT | 연결 종료 -- 세션을 깔끔하게 종료하여 서버가 리소스를 해제할 수 있도록 함 | `QUIT` |

### FTP 응답 코드

| 코드 범위 | 의미 | 예시 |
|-----------|------|------|
| 1xx | 긍정 예비 응답 | 150 파일 상태 OK |
| 2xx | 긍정 완료 응답 | 200 명령 OK, 226 전송 완료 |
| 3xx | 긍정 중간 응답 | 331 사용자명 OK, 비밀번호 필요 |
| 4xx | 부정 일시 응답 | 421 서비스 불가 |
| 5xx | 부정 영구 응답 | 530 로그인 실패, 550 권한 없음 |

### FTP 클라이언트 사용

```bash
# 기본 FTP 클라이언트
ftp ftp.example.com

# 연결 후 명령어
ftp> user username
ftp> pass password
ftp> ls              # 목록 확인
ftp> cd directory    # 디렉토리 이동
ftp> get file.txt    # 다운로드
ftp> put file.txt    # 업로드
ftp> binary          # 바이너리 모드
ftp> ascii           # ASCII 모드
ftp> passive         # Passive 모드 토글
ftp> bye             # 연결 종료
```

### SFTP와 FTPS

```
┌─────────────────────────────────────────────────────────────────┐
│                FTP vs SFTP vs FTPS                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  FTP          │  SFTP              │  FTPS                      │
│  (평문)       │  (SSH 기반)         │  (TLS/SSL 기반)            │
│               │                    │                            │
│  ┌─────────┐  │  ┌─────────┐       │  ┌─────────┐               │
│  │   FTP   │  │  │  SFTP   │       │  │   FTP   │               │
│  ├─────────┤  │  ├─────────┤       │  ├─────────┤               │
│  │   TCP   │  │  │   SSH   │       │  │ TLS/SSL │               │
│  └─────────┘  │  ├─────────┤       │  ├─────────┤               │
│               │  │   TCP   │       │  │   TCP   │               │
│  포트: 21     │  └─────────┘       │  └─────────┘               │
│               │                    │                            │
│  보안: 없음   │  포트: 22          │  포트: 990 (implicit)      │
│               │  보안: SSH 암호화   │        21 (explicit)       │
│               │                    │  보안: TLS 암호화          │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘

권장: SFTP 사용 (SSH 기반으로 단일 포트 사용)
```

---

## 3. 이메일 프로토콜

### 이메일 전송 구조

```
┌─────────────────────────────────────────────────────────────────┐
│                    이메일 전송 과정                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  [발신자]     [발신 서버]        [수신 서버]     [수신자]         │
│  alice@a.com   mail.a.com        mail.b.com    bob@b.com        │
│      │            │                  │            │             │
│      │──(1) SMTP─▶│                  │            │             │
│      │   (작성)   │                  │            │             │
│      │            │                  │            │             │
│      │            │──(2) SMTP───────▶│            │             │
│      │            │   (서버 간 전송)  │            │             │
│      │            │                  │            │             │
│      │            │                  │──(3) 저장─▶│             │
│      │            │                  │   (메일박스) │            │
│      │            │                  │            │             │
│      │            │                  │◀─(4) POP3/IMAP──│        │
│      │            │                  │   (메일 수신)   │         │
│                                                                 │
│  프로토콜:                                                      │
│  - SMTP: 메일 전송 (발송)                                        │
│  - POP3: 메일 수신 (다운로드 후 삭제)                             │
│  - IMAP: 메일 수신 (서버에 유지)                                  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### SMTP (Simple Mail Transfer Protocol)

```
┌─────────────────────────────────────────────────────────────────┐
│                      SMTP 정보                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  포트: TCP 25 (기본), 587 (submission), 465 (SSL)               │
│  RFC: 5321                                                      │
│  용도: 이메일 전송                                               │
│                                                                 │
│  SMTP 세션 예시:                                                │
│                                                                 │
│  C: 연결 (TCP 25)                                               │
│  S: 220 mail.example.com ESMTP ready                            │
│  C: EHLO client.example.com                                     │
│  S: 250-mail.example.com Hello                                  │
│  S: 250-AUTH LOGIN PLAIN                                        │
│  S: 250 STARTTLS                                                │
│  C: MAIL FROM:<alice@example.com>                               │
│  S: 250 OK                                                      │
│  C: RCPT TO:<bob@example.com>                                   │
│  S: 250 OK                                                      │
│  C: DATA                                                        │
│  S: 354 Start mail input                                        │
│  C: Subject: Test                                               │
│  C:                                                             │
│  C: Hello, this is a test.                                      │
│  C: .                                                           │
│  S: 250 OK Message queued                                       │
│  C: QUIT                                                        │
│  S: 221 Bye                                                     │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### SMTP 주요 명령어

> **왜 SMTP는 이메일 전체를 한 번에 보내는 대신 다단계 명령어 시퀀스를 사용하는가?** 각 명령어는 서버 응답 코드(Response Code)를 발생시켜, 오류를 조기에 감지하는 체크포인트(Checkpoint)를 만듭니다. 수신자 주소가 유효하지 않으면 서버는 RCPT TO 단계에서 거부합니다 -- 클라이언트가 대용량 첨부 파일을 업로드하여 대역폭을 낭비하기 전에 말입니다. 이 "봉투 먼저, 내용 나중에(Envelope First, Content Second)" 설계는 라우팅 정보와 메시지 본문을 분리하여, 중계 서버(Relay Server)가 봉투만으로 메일을 전달할 수 있게 합니다.

| 명령 | 설명 |
|------|------|
| HELO/EHLO | 클라이언트 식별 (EHLO는 확장 SMTP). 왜 자기 소개를 하는가? 서버가 이를 통해 어떤 기능(AUTH, STARTTLS, SIZE 제한)을 제공할지 결정합니다. EHLO는 기능 협상(Feature Negotiation)을 가능하게 하기 위해 HELO를 대체했습니다. |
| MAIL FROM | 발신자 지정 -- 반송 처리(Bounce Handling)에 사용되는 "봉투 발신자(Envelope From)" 주소를 정의합니다 (읽는 사람에게 보이는 "From:" 헤더와는 다름) |
| RCPT TO | 수신자 지정 -- 여러 수신자에 대해 반복 가능; 서버는 메시지 본문을 수락하기 전에 각 수신자를 검증합니다 |
| DATA | 메일 내용 시작 -- 봉투 명령어에서 실제 메시지 본문으로의 전환을 알리며, 단독 "."이 있는 줄로 종료됩니다 |
| QUIT | 연결 종료 -- 서버가 큐잉(Queuing)을 완료하고 TCP 소켓을 해제할 수 있도록 합니다 |
| AUTH | 인증 -- 개방형 릴레이(Open Relay)를 방지하기 위해 발신자의 신원을 증명합니다; 이것 없이는 누구나 서버를 사용해 스팸을 보낼 수 있습니다 |
| STARTTLS | TLS 암호화 시작 -- 세션 중간에 평문 연결을 암호화 연결로 업그레이드하여, 자격 증명(Credentials)과 메시지 내용을 도청(Eavesdropping)으로부터 보호합니다 |
| RSET | 트랜잭션 초기화 -- 연결을 끊지 않고 현재 메시지를 포기합니다; 클라이언트가 작성 중 오류를 감지했을 때 유용합니다 |

### POP3 (Post Office Protocol v3)

```
┌─────────────────────────────────────────────────────────────────┐
│                      POP3 정보                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  포트: TCP 110 (기본), 995 (SSL/TLS)                            │
│  RFC: 1939                                                      │
│  용도: 이메일 수신 (다운로드)                                     │
│                                                                 │
│  특징:                                                          │
│  - 메일을 로컬로 다운로드                                        │
│  - 서버에서 삭제 (기본)                                          │
│  - 단일 기기에서 사용 적합                                       │
│  - 오프라인 읽기 가능                                            │
│                                                                 │
│  POP3 세션 예시:                                                │
│                                                                 │
│  S: +OK POP3 server ready                                       │
│  C: USER alice                                                  │
│  S: +OK                                                         │
│  C: PASS password123                                            │
│  S: +OK Logged in                                               │
│  C: STAT                                                        │
│  S: +OK 3 1024                                                  │
│  C: LIST                                                        │
│  S: +OK 3 messages                                              │
│  S: 1 512                                                       │
│  S: 2 256                                                       │
│  S: 3 256                                                       │
│  S: .                                                           │
│  C: RETR 1                                                      │
│  S: +OK 512 octets                                              │
│  S: (메일 내용)                                                 │
│  S: .                                                           │
│  C: DELE 1                                                      │
│  S: +OK Deleted                                                 │
│  C: QUIT                                                        │
│  S: +OK Bye                                                     │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### IMAP (Internet Message Access Protocol)

```
┌─────────────────────────────────────────────────────────────────┐
│                      IMAP 정보                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  포트: TCP 143 (기본), 993 (SSL/TLS)                            │
│  RFC: 3501 (IMAP4)                                              │
│  용도: 이메일 수신 (서버 동기화)                                  │
│                                                                 │
│  특징:                                                          │
│  - 메일을 서버에 보관                                            │
│  - 여러 기기에서 동기화                                          │
│  - 폴더 관리 가능                                                │
│  - 부분 다운로드 지원                                            │
│  - 온라인 상태 필요                                              │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### POP3 vs IMAP 비교

| 특성 | POP3 | IMAP |
|------|------|------|
| 메일 저장 위치 | 로컬 (다운로드) | 서버 |
| 다중 기기 동기화 | 어려움 | 지원 |
| 오프라인 읽기 | 용이 | 제한적 |
| 서버 저장 공간 | 적음 | 많음 필요 |
| 폴더 관리 | 제한적 | 지원 |
| 부분 다운로드 | 불가 | 가능 |
| 적합한 용도 | 단일 기기 | 다중 기기 |

### 이메일 포트 정리

| 프로토콜 | 포트 | 보안 |
|----------|------|------|
| SMTP | 25 | 평문 |
| SMTP Submission | 587 | STARTTLS |
| SMTPS | 465 | SSL/TLS |
| POP3 | 110 | 평문 |
| POP3S | 995 | SSL/TLS |
| IMAP | 143 | 평문 |
| IMAPS | 993 | SSL/TLS |

---

## 4. SSH

### SSH 개요

SSH(Secure Shell)는 네트워크 상에서 암호화된 원격 접속을 제공하는 프로토콜입니다.

```
┌─────────────────────────────────────────────────────────────────┐
│                      SSH 정보                                    │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  포트: TCP 22                                                   │
│  RFC: 4251-4256                                                 │
│  버전: SSH-2 (권장), SSH-1 (폐기)                                │
│                                                                 │
│  기능:                                                          │
│  - 암호화된 원격 쉘 접속                                         │
│  - 파일 전송 (SCP, SFTP)                                        │
│  - 포트 포워딩/터널링                                            │
│  - X11 포워딩                                                   │
│                                                                 │
│  인증 방식:                                                     │
│  - 비밀번호 인증                                                │
│  - 공개키 인증 (권장)                                           │
│  - 호스트 기반 인증                                              │
│  - 키보드 인터랙티브                                             │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### SSH 연결 과정

```
┌─────────────────────────────────────────────────────────────────┐
│                    SSH 연결 과정                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  [클라이언트]                              [서버]                │
│      │                                        │                 │
│      │──(1) TCP 연결 (포트 22) ────────────▶ │                 │
│      │                                        │                 │
│      │◀─(2) 프로토콜 버전 교환 ──────────────│                 │
│      │     SSH-2.0-OpenSSH_8.9               │                 │
│      │                                        │                 │
│      │◀──(3) 키 교환 알고리즘 협상 ─────────▶│                 │
│      │     암호화, MAC, 압축 알고리즘        │                 │
│      │                                        │                 │
│      │◀──(4) 키 교환 (DH/ECDH) ────────────▶│                 │
│      │     세션 키 생성                       │                 │
│      │                                        │                 │
│      │◀════(5) 암호화된 통신 시작 ══════════▶│                 │
│      │                                        │                 │
│      │──(6) 사용자 인증 ─────────────────▶  │                 │
│      │     (비밀번호 또는 공개키)             │                 │
│      │                                        │                 │
│      │◀─(7) 인증 성공 ──────────────────────│                 │
│      │                                        │                 │
│      │◀════(8) 쉘 세션 시작 ════════════════▶│                 │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### SSH 공개키 인증

```
┌─────────────────────────────────────────────────────────────────┐
│                    SSH 공개키 인증 원리                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  [클라이언트]                              [서버]                │
│                                                                 │
│  개인키 (id_ed25519)                 공개키 (authorized_keys)   │
│  ┌──────────────────┐               ┌──────────────────┐        │
│  │ 절대 공개 금지    │               │ 클라이언트       │        │
│  │ 로컬에만 보관    │               │ 공개키 저장      │        │
│  └──────────────────┘               └──────────────────┘        │
│           │                                   │                 │
│           │                                   │                 │
│  인증 과정:                                                     │
│  1. 서버가 무작위 챌린지 전송                                    │
│  2. 클라이언트가 개인키로 챌린지 서명                             │
│  3. 서버가 공개키로 서명 검증                                     │
│  4. 검증 성공 시 인증 완료                                       │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### SSH 주요 명령어

```bash
# 기본 접속
ssh user@hostname
ssh -p 2222 user@hostname    # 포트 지정
# 왜 포트를 변경하는가? SSH를 22번 포트에서 옮기면 인터넷 전체에서 기본 포트를
# 스캔하는 봇(Bot)의 자동화된 무차별 대입(Brute-force) 로그인 시도를 줄일 수 있습니다.

# 키 생성
ssh-keygen -t ed25519 -C "email@example.com"
# 왜 ed25519인가? 타원 곡선 암호화(Elliptic Curve Cryptography)를 사용하여
# RSA-3072와 동등한 보안을 훨씬 짧은 키(256비트)로 제공하므로, 핸드셰이크가
# 더 빠르고 키 관리가 간단합니다.
ssh-keygen -t rsa -b 4096
# 왜 4096비트인가? RSA-2048은 2030년까지의 보안 최소 기준으로 간주됩니다.
# 4096은 수명이 긴 키에 추가 여유를 제공하며, 대가는 약간 느려진
# 핸드셰이크(Handshake)입니다.

# 공개키 복사
ssh-copy-id user@hostname
ssh-copy-id -i ~/.ssh/id_ed25519.pub user@hostname
# 왜 ssh-copy-id를 사용하는가? 올바른 권한(600)으로 공개키를 원격
# authorized_keys 파일에 안전하게 추가합니다. 파일 권한이 너무 넓으면
# SSH가 해당 키를 거부하는 흔한 실수를 방지할 수 있습니다.

# 파일 전송 (SCP)
scp file.txt user@host:/path/
scp user@host:/path/file.txt ./
scp -r directory/ user@host:/path/
# 왜 FTP 대신 SCP인가? SCP는 기존 SSH 암호화 채널(Encrypted Channel)을 재사용
# 하므로, 추가 포트를 열거나 별도의 자격 증명을 구성할 필요가 없습니다.

# SFTP
sftp user@hostname
# 왜 SCP 대신 SFTP인가? SFTP는 전송 재개(Resumable Transfer), 디렉토리 목록,
# 원격 파일 작업(이름 변경, 삭제) 등 SCP에 없는 기능을 지원합니다.
```

### SSH 터널링

> **왜 포트를 직접 열지 않고 SSH를 통해 터널링하는가?** SSH 터널링은 두 가지 문제를 동시에 해결합니다: 평문으로 전송될 트래픽을 암호화하고, 거의 항상 허용되는 22번 포트에 편승하여 방화벽(Firewall) 제한을 우회합니다. 운영 환경에서 데이터베이스 접근이 데이터베이스 포트를 네트워크에 노출하는 대신 SSH 점프 서버(Jump Server)를 통하는 이유가 바로 이것입니다.

```bash
# 로컬 포트 포워딩
# 로컬 8080 → 원격 서버 경유 → 대상 서버 80
ssh -L 8080:target.example.com:80 user@jump.example.com
# 왜 로컬 포워딩인가? 자신의 머신에서는 접근할 수 없지만 점프 서버에서는
# 접근 가능한 서비스(예: 내부 DB)에 접근해야 할 때 사용합니다. 터널은
# 해당 서비스가 마치 localhost에서 실행되는 것처럼 만듭니다.

# 원격 포트 포워딩
# 원격 서버 8080 → 로컬 머신 80
ssh -R 8080:localhost:80 user@remote.example.com
# 왜 원격 포워딩인가? 라우터에서 NAT나 포트 포워딩을 설정하지 않고도
# 로컬 개발 서버를 인터넷에 노출하고 싶을 때 사용합니다.

# 동적 포트 포워딩 (SOCKS 프록시)
ssh -D 1080 user@proxy.example.com
# 왜 동적 포워딩인가? 범용 SOCKS 프록시(Proxy)를 생성하여 모든 트래픽을
# SSH 서버를 통해 라우팅합니다 -- 신뢰할 수 없는 네트워크에서 브라우징을
# 암호화하거나 지역 제한 콘텐츠에 접근할 때 유용합니다.
```

```
┌─────────────────────────────────────────────────────────────────┐
│                    SSH 로컬 포트 포워딩                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ssh -L 8080:db.internal:3306 user@jump.example.com             │
│                                                                 │
│  [로컬 PC]          [점프 서버]          [DB 서버]               │
│  localhost:8080      jump.example.com    db.internal:3306       │
│      │                    │                   │                 │
│      │════ SSH 터널 ════▶│                   │                 │
│      │                    │──────────────────▶│                 │
│      │                    │                   │                 │
│      │◀═══════════════════│◀──────────────────│                 │
│                                                                 │
│  사용: mysql -h 127.0.0.1 -P 8080 (로컬에서 DB 접속)             │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 5. Telnet

### Telnet 개요

Telnet은 원격 호스트에 터미널 접속을 제공하는 프로토콜입니다. **보안상 SSH 사용 권장**.

```
┌─────────────────────────────────────────────────────────────────┐
│                      Telnet 정보                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  포트: TCP 23                                                   │
│  RFC: 854                                                       │
│                                                                 │
│  특징:                                                          │
│  - 평문 전송 (암호화 없음)                                       │
│  - 비밀번호 노출 위험                                            │
│  - 스니핑에 취약                                                 │
│  - 레거시 시스템에서만 사용                                       │
│                                                                 │
│  ⚠️  보안 경고:                                                  │
│  - 인터넷에서 Telnet 사용 금지                                   │
│  - SSH로 대체 필요                                               │
│  - 내부망에서도 가급적 피할 것                                    │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### Telnet 활용 (테스트용)

Telnet은 보안상 원격 접속에는 부적합하지만, 포트 연결 테스트에 유용합니다.

```bash
# 포트 연결 테스트
telnet example.com 80
telnet example.com 443

# HTTP 테스트
telnet example.com 80
GET / HTTP/1.1
Host: example.com
(빈 줄)

# SMTP 테스트
telnet mail.example.com 25
EHLO test
QUIT

# 연결 확인만 (nc 권장)
nc -zv example.com 80
nc -zv example.com 22
```

### Telnet vs SSH

| 특성 | Telnet | SSH |
|------|--------|-----|
| 포트 | 23 | 22 |
| 암호화 | 없음 (평문) | 있음 |
| 인증 | 평문 비밀번호 | 다양한 방식 |
| 보안 | 매우 취약 | 강함 |
| 파일 전송 | 없음 | SCP, SFTP |
| 터널링 | 없음 | 지원 |
| 사용 권장 | 테스트용만 | 항상 권장 |

---

## 6. WebSocket

### WebSocket 개요

WebSocket은 클라이언트와 서버 간 양방향 실시간 통신을 제공하는 프로토콜입니다.

```
┌─────────────────────────────────────────────────────────────────┐
│                    WebSocket 정보                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  포트: TCP 80 (ws://), TCP 443 (wss://)                         │
│  RFC: 6455                                                      │
│                                                                 │
│  특징:                                                          │
│  - HTTP 업그레이드로 시작                                        │
│  - 양방향 (Full-Duplex) 통신                                    │
│  - 지속 연결 (Persistent Connection)                            │
│  - 낮은 오버헤드 (헤더 최소화)                                   │
│  - 실시간 데이터 전송                                            │
│                                                                 │
│  활용 사례:                                                     │
│  - 실시간 채팅                                                  │
│  - 온라인 게임                                                  │
│  - 주식/가상화폐 시세                                           │
│  - 라이브 스트리밍                                              │
│  - 협업 도구                                                    │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### HTTP vs WebSocket

```
┌─────────────────────────────────────────────────────────────────┐
│                  HTTP vs WebSocket                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  HTTP (요청-응답)                 WebSocket (양방향)             │
│                                                                 │
│  클라이언트      서버             클라이언트      서버            │
│      │            │                  │            │             │
│      │──요청1 ──▶│                  │══연결══════│             │
│      │◀──응답1 ──│                  │            │             │
│      │            │                  │◀─ 메시지 ──│             │
│      │──요청2 ──▶│                  │── 메시지 ─▶│             │
│      │◀──응답2 ──│                  │◀─ 메시지 ──│             │
│      │            │                  │── 메시지 ─▶│             │
│      │──요청3 ──▶│                  │            │             │
│      │◀──응답3 ──│                  │◀─ 메시지 ──│             │
│                                     │══연결 종료═│              │
│                                                                 │
│  매번 연결 생성                     한 번 연결, 지속 통신          │
│  클라이언트만 요청 가능             양쪽 모두 전송 가능            │
│  요청 헤더 오버헤드                 최소 프레임 헤더               │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### WebSocket 핸드셰이크

```
┌─────────────────────────────────────────────────────────────────┐
│                  WebSocket 핸드셰이크                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  [클라이언트 요청 - HTTP Upgrade]                               │
│  ─────────────────────────────────                              │
│  GET /chat HTTP/1.1                                             │
│  Host: server.example.com                                       │
│  Upgrade: websocket                                             │
│  Connection: Upgrade                                            │
│  Sec-WebSocket-Key: dGhlIHNhbXBsZSBub25jZQ==                   │
│  Sec-WebSocket-Version: 13                                      │
│                                                                 │
│  [서버 응답 - 101 Switching Protocols]                          │
│  ──────────────────────────────────────                         │
│  HTTP/1.1 101 Switching Protocols                               │
│  Upgrade: websocket                                             │
│  Connection: Upgrade                                            │
│  Sec-WebSocket-Accept: s3pPLMBiTxaQ9kYGzzhZRbK+xOo=             │
│                                                                 │
│  [이후 WebSocket 프레임으로 통신]                                │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### WebSocket 클라이언트 (JavaScript)

```javascript
// WebSocket 연결
const socket = new WebSocket('wss://example.com/chat');

// 연결 성공
socket.onopen = function(event) {
    console.log('WebSocket 연결됨');
    socket.send('Hello Server!');
};

// 메시지 수신
socket.onmessage = function(event) {
    console.log('메시지 수신:', event.data);
};

// 연결 종료
socket.onclose = function(event) {
    console.log('연결 종료:', event.code, event.reason);
};

// 에러 처리
socket.onerror = function(error) {
    console.error('WebSocket 에러:', error);
};

// 메시지 전송
socket.send(JSON.stringify({ type: 'chat', message: 'Hello!' }));

// 연결 종료
socket.close();
```

### WebSocket 서버 (Node.js)

```javascript
const WebSocket = require('ws');

const wss = new WebSocket.Server({ port: 8080 });

wss.on('connection', function(ws) {
    console.log('클라이언트 연결됨');

    // 메시지 수신
    ws.on('message', function(message) {
        console.log('받은 메시지:', message);

        // 에코 응답
        ws.send('서버 응답: ' + message);

        // 모든 클라이언트에게 브로드캐스트
        wss.clients.forEach(function(client) {
            if (client.readyState === WebSocket.OPEN) {
                client.send(message);
            }
        });
    });

    ws.on('close', function() {
        console.log('클라이언트 연결 종료');
    });
});
```

---

## 7. 연습 문제

### 기초 문제

1. **DHCP**
   - DORA의 각 단계를 설명하세요.
   - DHCP 서버가 할당하는 정보를 모두 나열하세요.

2. **FTP**
   - Active 모드와 Passive 모드의 차이는?
   - FTP의 보안 문제와 대안을 설명하세요.

3. **이메일**
   - SMTP, POP3, IMAP의 역할을 각각 설명하세요.
   - POP3와 IMAP의 차이점은?

### 중급 문제

4. **SSH**
   - SSH 공개키 인증의 장점은?
   - SSH 로컬 포트 포워딩을 사용하는 상황 예시를 제시하세요.

5. **포트 번호**
   - 다음 프로토콜의 포트 번호를 쓰세요:
     - DHCP (클라이언트/서버)
     - FTP (제어/데이터)
     - SMTP (기본/SSL)
     - SSH
     - POP3S
     - IMAPS

6. **실습 문제**

```bash
# 다음 명령의 결과를 예측하세요

# 1. SSH 터널을 통해 원격 DB에 접속
ssh -L 3306:db.internal:3306 user@bastion.example.com
mysql -h 127.0.0.1 -P 3306 -u dbuser -p

# 2. SFTP로 파일 업로드
sftp user@server.example.com
put localfile.txt /home/user/

# 3. Telnet으로 HTTP 테스트
telnet example.com 80
GET / HTTP/1.1
Host: example.com
```

### 고급 문제

7. **WebSocket**
   - HTTP Polling과 WebSocket의 차이는?
   - WebSocket이 HTTP를 통해 핸드셰이크하는 이유는?

8. **보안 비교**
   - Telnet, FTP, SMTP의 보안 문제점을 설명하세요.
   - 각각의 보안 대안은 무엇인가요?

---

## 8. 참고 자료

### RFC 문서

- [RFC 2131](https://tools.ietf.org/html/rfc2131) - DHCP
- [RFC 959](https://tools.ietf.org/html/rfc959) - FTP
- [RFC 5321](https://tools.ietf.org/html/rfc5321) - SMTP
- [RFC 1939](https://tools.ietf.org/html/rfc1939) - POP3
- [RFC 3501](https://tools.ietf.org/html/rfc3501) - IMAP
- [RFC 4251-4256](https://tools.ietf.org/html/rfc4251) - SSH
- [RFC 6455](https://tools.ietf.org/html/rfc6455) - WebSocket

### 포트 번호 요약

| 프로토콜 | 평문 포트 | 보안 포트 |
|----------|-----------|-----------|
| FTP | 21 (제어), 20 (데이터) | 990 (FTPS) |
| SSH/SFTP | 22 | - |
| Telnet | 23 | - |
| SMTP | 25, 587 | 465 |
| DNS | 53 | 853 (DoT) |
| DHCP | 67/68 | - |
| HTTP | 80 | 443 (HTTPS) |
| POP3 | 110 | 995 |
| IMAP | 143 | 993 |

---

**이전**: [HTTP와 HTTPS](./13_HTTP_and_HTTPS.md) | **다음**: [네트워크 보안 기초](./15_Network_Security_Basics.md)
