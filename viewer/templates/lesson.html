{% extends "base.html" %}

{% block title %}{{ title }} - Study Viewer{% endblock %}

{% block header %}
<nav class="breadcrumb">
    <a href="{{ url_for('index', lang=lang) }}">Topics</a>
    <span class="separator">/</span>
    <a href="{{ url_for('topic', lang=lang, name=topic) }}">{{ topic.replace('_', ' ') }}</a>
    <span class="separator">/</span>
    <span class="current">{{ title }}</span>
</nav>
{% endblock %}

{% block content %}
<article class="lesson-article" data-lang="{{ lang }}" data-topic="{{ topic }}" data-filename="{{ filename }}">
    <header class="lesson-header">
        <h1>{{ title }}</h1>
        <div class="lesson-actions-bar">
            <button class="btn btn-read {% if is_read %}active{% endif %}" id="mark-read-btn" title="Mark as read">
                <span class="icon">{% if is_read %}âœ“{% else %}â—‹{% endif %}</span>
                <span class="text">{% if is_read %}Read{% else %}Mark as read{% endif %}</span>
            </button>
            <button class="btn btn-bookmark {% if is_bookmarked %}active{% endif %}" id="bookmark-btn" title="Bookmark">
                <span class="icon">ðŸ”–</span>
                <span class="text">{% if is_bookmarked %}Bookmarked{% else %}Bookmark{% endif %}</span>
            </button>
            <button class="btn btn-copy-link" id="copy-link-btn" title="Copy link">
                <span class="icon">ðŸ”—</span>
                <span class="text">Copy link</span>
            </button>
        </div>
    </header>

    {% if toc %}
    <nav class="toc" id="toc">
        <h2>Table of Contents</h2>
        {{ toc|safe }}
    </nav>
    {% endif %}

    <div class="lesson-content markdown-body">
        {{ content|safe }}
    </div>

    <footer class="lesson-footer">
        <nav class="lesson-nav">
            {% if prev_lesson %}
            <a href="{{ url_for('lesson', lang=lang, name=topic, filename=prev_lesson.filename) }}" class="nav-prev">
                <span class="nav-label">Previous</span>
                <span class="nav-title">{{ prev_lesson.title or prev_lesson.display_name }}</span>
            </a>
            {% else %}
            <span class="nav-placeholder"></span>
            {% endif %}

            {% if next_lesson %}
            <a href="{{ url_for('lesson', lang=lang, name=topic, filename=next_lesson.filename) }}" class="nav-next">
                <span class="nav-label">Next</span>
                <span class="nav-title">{{ next_lesson.title or next_lesson.display_name }}</span>
            </a>
            {% endif %}
        </nav>
    </footer>
</article>
{% endblock %}

{% block scripts %}
<script>
    // Initialize lesson page
    document.addEventListener('DOMContentLoaded', function() {
        const article = document.querySelector('.lesson-article');
        const lang = article.dataset.lang;
        const topic = article.dataset.topic;
        const filename = article.dataset.filename;

        // Mark as read button
        const readBtn = document.getElementById('mark-read-btn');
        readBtn.addEventListener('click', async function() {
            const isRead = !this.classList.contains('active');
            const response = await fetch('/api/mark-read', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ lang, topic, filename, is_read: isRead })
            });
            if (response.ok) {
                this.classList.toggle('active', isRead);
                this.querySelector('.icon').textContent = isRead ? 'âœ“' : 'â—‹';
                this.querySelector('.text').textContent = isRead ? 'Read' : 'Mark as read';
            }
        });

        // Bookmark button
        const bookmarkBtn = document.getElementById('bookmark-btn');
        bookmarkBtn.addEventListener('click', async function() {
            const response = await fetch('/api/bookmark', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ lang, topic, filename })
            });
            if (response.ok) {
                const data = await response.json();
                this.classList.toggle('active', data.bookmarked);
                this.querySelector('.text').textContent = data.bookmarked ? 'Bookmarked' : 'Bookmark';
            }
        });

        // Copy link button
        const copyBtn = document.getElementById('copy-link-btn');
        copyBtn.addEventListener('click', function() {
            navigator.clipboard.writeText(window.location.href);
            const originalText = this.querySelector('.text').textContent;
            this.querySelector('.text').textContent = 'Copied!';
            setTimeout(() => {
                this.querySelector('.text').textContent = originalText;
            }, 2000);
        });

        // Add copy buttons to code blocks
        document.querySelectorAll('pre code').forEach((block) => {
            const wrapper = document.createElement('div');
            wrapper.className = 'code-block-wrapper';
            block.parentNode.insertBefore(wrapper, block.parentNode.firstChild);
            wrapper.appendChild(block.parentNode.removeChild(block).parentNode || block);

            const copyBtn = document.createElement('button');
            copyBtn.className = 'code-copy-btn';
            copyBtn.textContent = 'Copy';
            copyBtn.addEventListener('click', () => {
                navigator.clipboard.writeText(block.textContent);
                copyBtn.textContent = 'Copied!';
                setTimeout(() => copyBtn.textContent = 'Copy', 2000);
            });
            wrapper.querySelector('pre').appendChild(copyBtn);
        });
    });
</script>
{% endblock %}
