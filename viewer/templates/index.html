{% extends "base.html" %}

{% block title %}Study Viewer - Home{% endblock %}

{% block header %}
<h1>Home</h1>
<p class="header-subtitle">Your learning hub</p>
{% endblock %}

{% block content %}
<div class="home">
    <!-- Overall Progress -->
    <section class="home-section">
        <h2>Overview</h2>
        <div class="overall-stats">
            <div class="stat-card highlight">
                <span class="stat-value">{{ overall.percentage }}%</span>
                <span class="stat-label">Complete</span>
            </div>
            <div class="stat-card">
                <span class="stat-value">{{ overall.read }}/{{ overall.total }}</span>
                <span class="stat-label">Lessons Read</span>
            </div>
            <div class="stat-card">
                <span class="stat-value">{{ bookmark_count }}</span>
                <span class="stat-label">Bookmarks</span>
            </div>
        </div>
        <div class="progress-bar xlarge">
            <div class="progress-fill" style="width: {{ overall.percentage }}%"></div>
        </div>
    </section>

    <!-- Continue Learning -->
    {% if in_progress %}
    <section class="home-section">
        <h2>Continue Learning</h2>
        <div class="continue-list">
            {% for topic in in_progress %}
            <a href="{{ url_for('topic', lang=lang, name=topic.name) }}" class="continue-item">
                <div class="continue-info">
                    <span class="continue-name">{{ topic.display_name }}</span>
                    <span class="continue-stats">{{ topic.progress.read }}/{{ topic.progress.total }}</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: {{ topic.progress.percentage }}%"></div>
                </div>
                <span class="progress-percentage">{{ topic.progress.percentage }}%</span>
            </a>
            {% endfor %}
        </div>
    </section>
    {% endif %}

    <!-- Recently Read -->
    <section class="home-section">
        <h2>Recently Read</h2>
        {% if recent_reads %}
        <div class="recent-list">
            {% for item in recent_reads %}
            <a href="{{ url_for('lesson', lang=lang, name=item.topic, filename=item.filename) }}" class="recent-item">
                <div class="recent-info">
                    <span class="recent-topic">{{ item.topic.replace('_', ' ') }}</span>
                    <span class="recent-title">{{ item.title }}</span>
                </div>
                <span class="recent-time">{{ item.read_at|timeago }}</span>
            </a>
            {% endfor %}
        </div>
        {% else %}
        <p class="home-empty">No lessons read yet. Start exploring topics below!</p>
        {% endif %}
    </section>

    <!-- Bookmarks -->
    {% if bookmarks %}
    <section class="home-section">
        <div class="home-section-header">
            <h2>Bookmarks</h2>
            <a href="{{ url_for('bookmarks', lang=lang) }}" class="home-section-link">View all</a>
        </div>
        <div class="recent-list">
            {% for item in bookmarks %}
            <a href="{{ url_for('lesson', lang=lang, name=item.topic, filename=item.filename) }}" class="recent-item">
                <div class="recent-info">
                    <span class="recent-topic">{{ item.topic.replace('_', ' ') }}</span>
                    <span class="recent-title">{{ item.title }}</span>
                </div>
            </a>
            {% endfor %}
        </div>
    </section>
    {% endif %}

    <!-- Topics by Tier -->
    <section class="home-section">
        <div class="home-section-header">
            <h2>All Topics ({{ topics|length }})</h2>
        </div>

        <!-- Tier Filter & Sort Controls -->
        <div class="topic-controls">
            <div class="tier-filters">
                <button class="tier-filter-btn active" data-tier="all">
                    {% if lang == 'ko' %}전체{% else %}All{% endif %}
                </button>
                {% for tier in tiers %}
                <button class="tier-filter-btn" data-tier="{{ tier.id }}" style="--tier-color: {{ tier.color }}">
                    {{ tier.label[lang] }}
                </button>
                {% endfor %}
            </div>
            <div class="topic-sort">
                <span class="topic-sort-label">{% if lang == 'ko' %}정렬{% else %}Sort{% endif %}</span>
                <button class="topic-sort-btn active" data-sort="name">{% if lang == 'ko' %}이름{% else %}Name{% endif %}</button>
                <button class="topic-sort-btn" data-sort="progress">{% if lang == 'ko' %}진행률{% else %}Progress{% endif %}</button>
                <button class="topic-sort-btn" data-sort="lessons">{% if lang == 'ko' %}레슨 수{% else %}Lessons{% endif %}</button>
            </div>
        </div>

        <!-- Tier Groups -->
        {% for tier in tiers %}
        {% set group_topics = tier_groups.get(tier.id, []) %}
        {% if group_topics %}
        <div class="tier-group" data-tier="{{ tier.id }}" style="--tier-color: {{ tier.color }}">
            <h3 class="tier-group-title">
                <span class="tier-badge tier-{{ tier.id }}">{{ tier.label[lang] }}</span>
                <span class="tier-group-desc">{{ tier.description[lang] }}</span>
                <span class="tier-group-count">({{ group_topics|length }})</span>
            </h3>
            <div class="topics-grid">
                {% for topic in group_topics %}
                <a href="{{ url_for('topic', lang=lang, name=topic.name) }}" class="topic-card"
                   data-name="{{ topic.display_name }}" data-progress="{{ topic.progress.percentage }}" data-lessons="{{ topic.lesson_count }}">
                    <div class="topic-card-header">
                        <h4 class="topic-name">{{ topic.display_name }}</h4>
                        <span class="lesson-count">{{ topic.lesson_count }} lessons</span>
                    </div>
                    <div class="topic-card-progress">
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: {{ topic.progress.percentage }}%"></div>
                        </div>
                        <span class="progress-text">{{ topic.progress.read }}/{{ topic.progress.total }} completed</span>
                    </div>
                </a>
                {% endfor %}
            </div>
        </div>
        {% endif %}
        {% endfor %}

        {% if tier_groups.get('uncategorized') %}
        <div class="tier-group" data-tier="uncategorized">
            <h3 class="tier-group-title">
                <span class="tier-badge">Uncategorized</span>
            </h3>
            <div class="topics-grid">
                {% for topic in tier_groups['uncategorized'] %}
                <a href="{{ url_for('topic', lang=lang, name=topic.name) }}" class="topic-card">
                    <div class="topic-card-header">
                        <h4 class="topic-name">{{ topic.display_name }}</h4>
                        <span class="lesson-count">{{ topic.lesson_count }} lessons</span>
                    </div>
                </a>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </section>
</div>
{% endblock %}
